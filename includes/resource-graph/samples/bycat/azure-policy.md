---
author: timwarner-msft
ms.service: resource-graph
ms.topic: include
ms.date: 06/14/2022
ms.author: timwarner
ms.custom: generated
---

### Policy assignments and definition information for the built-in definitions assigned in your environment

This sample query gets policy assignments for built-in definitions assigned in your environment with the respective assignment name, built-in definition associated, category of definition (if applicable), as well as whether the definition type is an initiative or a single policy.

```kusto
policyresources
| where type =~'Microsoft.Authorization/PolicyAssignments'
| project policyAssignmentId = tolower(tostring(id)), policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId)
| join kind=inner(
 policyresources
 | where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions'
 | where isnotempty(properties.policyType) and properties.policyType == 'BuiltIn'
 | project definitionId = tolower(id), category = tostring(properties.metadata.category), definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy'), policyType = tostring(properties.policyType)
) on $left.policyAssignmentDefinitionId == $right.definitionId
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "policyresources | where type =~'Microsoft.Authorization/PolicyAssignments' | project policyAssignmentId = tolower(tostring(id)), policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId) | join kind=inner(  policyresources  | where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions'  | where isnotempty(properties.policyType) and properties.policyType == 'BuiltIn'  | project definitionId = tolower(id), category = tostring(properties.metadata.category), definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy'), policyType = tostring(properties.policyType)  ) on $left.policyAssignmentDefinitionId == $right.definitionId"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "policyresources | where type =~'Microsoft.Authorization/PolicyAssignments' | project policyAssignmentId = tolower(tostring(id)), policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId) | join kind=inner(  policyresources  | where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions'  | where isnotempty(properties.policyType) and properties.policyType == 'BuiltIn'  | project definitionId = tolower(id), category = tostring(properties.metadata.category), definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy'), policyType = tostring(properties.policyType)  ) on $left.policyAssignmentDefinitionId == $right.definitionId"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyresources%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%20%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%20%7C%20join%20kind%3Dinner%28%20%20policyresources%20%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%20%20%7C%20where%20isnotempty%28properties.policyType%29%20and%20properties.policyType%20%3D%3D%20%27BuiltIn%27%20%20%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%2C%20policyType%20%3D%20tostring%28properties.policyType%29%20%20%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId" target="_blank">portal.Azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyresources%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%20%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%20%7C%20join%20kind%3Dinner%28%20%20policyresources%20%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%20%20%7C%20where%20isnotempty%28properties.policyType%29%20and%20properties.policyType%20%3D%3D%20%27BuiltIn%27%20%20%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%2C%20policyType%20%3D%20tostring%28properties.policyType%29%20%20%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId" target="_blank">portal.Azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyresources%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%20%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%20%7C%20join%20kind%3Dinner%28%20%20policyresources%20%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%20%20%7C%20where%20isnotempty%28properties.policyType%29%20and%20properties.policyType%20%3D%3D%20%27BuiltIn%27%20%20%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%2C%20policyType%20%3D%20tostring%28properties.policyType%29%20%20%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId" target="_blank">portal.Azure.cn</a>

---

### Policy assignments and information about each of its respective definitions

This query gets policy assignments in your environment with the respective assignment name,
definition associated, category of definition (if applicable), as well as whether the definition
type is an initiative or a single policy.

```kusto
policyResources
| where type =~'Microsoft.Authorization/PolicyAssignments'
| project policyAssignmentId = tolower(tostring(id)), policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId)
| join kind=leftouter(
 policyResources
 | where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions'
 | project definitionId = tolower(id), category = tostring(properties.metadata.category), definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy')
) on $left.policyAssignmentDefinitionId == $right.definitionId
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "policyResources | where type =~'Microsoft.Authorization/PolicyAssignments' | project policyAssignmentId = tolower(tostring(id)), policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId) | join kind=leftouter(policyResources | where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions' | project definitionId = tolower(id), category = tostring(properties.metadata.category), definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy')) on $left.policyAssignmentDefinitionId == $right.definitionId"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "policyResources | where type =~'Microsoft.Authorization/PolicyAssignments' | project policyAssignmentId = tolower(tostring(id)), policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId) | join kind=leftouter(policyResources | where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions' | project definitionId = tolower(id), category = tostring(properties.metadata.category), definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy')) on $left.policyAssignmentDefinitionId == $right.definitionId"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%20%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%20%7C%20join%20kind%3Dleftouter%28policyResources%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%20%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId" target="_blank">portal.Azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%20%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%20%7C%20join%20kind%3Dleftouter%28policyResources%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%20%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId" target="_blank">portal.Azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%20%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%20%7C%20join%20kind%3Dleftouter%28policyResources%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%20%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId" target="_blank">portal.Azure.cn</a>

---

### Breakdown of compliance information for each assignment at subscription/MG/tenant scope

This sample query gets aggregated compliance and policy definition information for each of the assignments in the selected scope as well as a few additional details. Those details include: policySetDefinition or policyDefinition details for those assignments, the number of policies/groups within the policysetDefinitions listed, the number of non-compliant policies within each policySetDefinition, and the resource count breakdown per compliance state for those assignments.

```kusto
policyResources
| where type =~'Microsoft.Authorization/PolicyAssignments'
| project policyAssignmentId = tolower(tostring(id)), policyAssignmentName = name, policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentScope = tostring(properties.scope), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId), policyAssignmentNotScopes = tolower(properties.notScopes)
| join kind=leftouter(
 policyResources
 | where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions'
 | project definitionId = tolower(id), type, numberOfPolicies = array_length(properties.policyDefinitions), category = tostring(properties.metadata.category), numberOfGroups= array_length(properties.policyDefinitionGroups), mode = tostring(properties.mode)
 | extend isRegulatoryInitiative = iff(category =~ 'Regulatory Compliance', true, false)
 | extend definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy')
 | extend isRPMode = iff(mode startswith 'Microsoft.', true, false)
 | project definitionId, numberOfPolicies, category, numberOfGroups, isRegulatoryInitiative, definitionType, isRPMode
) on $left.policyAssignmentDefinitionId == $right.definitionId
| join kind=leftouter(
 policyResources
 | where type =~ 'Microsoft.PolicyInsights/PolicyStates'
 | extend complianceState = tostring(properties.complianceState)
 | extend policyStateResourceId =id, resourceId = tostring(properties.resourceId), policyAssignmentId = tostring(properties.policyAssignmentId), policyDefinitionId = tostring(properties.policyDefinitionId), policySetDefinitionId = tostring(properties.policySetDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), policyDefinitionAction = tostring(properties.policyDefinitionAction), policyDefinitionGroupNames = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic([''])), stateWeight = toint(properties.stateWeight)
 | summarize max(stateWeight) by resourceId, policyAssignmentId, policySetDefinitionId
 | summarize resourceCounts = count() by policyAssignmentId, policySetDefinitionId, max_stateWeight
| extend complianceState = case(
max_stateWeight == 300, 'noncompliant',
max_stateWeight == 200, 'compliant',
max_stateWeight == 100, 'conflict',
max_stateWeight == 50, 'exempt',
max_stateWeight == 10, 'unknown',
'notapplicable')
 | extend pack = pack('complianceState', complianceState, 'resourceCounts', resourceCounts), numberOfNonCompliantResources = toint(iff(complianceState =~ 'NonCompliant', resourceCounts,0))
 | summarize numberOfNonCompliantResources = max(numberOfNonCompliantResources), details = makelist(pack) by policyAssignmentId, policySetDefinitionId
 | limit 5000
) on $left.policyAssignmentId == $right.policyAssignmentId
| sort by numberOfNonCompliantResources desc
| project-away policyAssignmentId1
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "policyResources | where type =~'Microsoft.Authorization/PolicyAssignments' | project policyAssignmentId = tolower(tostring(id)), policyAssignmentName = name, policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentScope = tostring(properties.scope), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId), policyAssignmentNotScopes = tolower(properties.notScopes) | join kind=leftouter(  policyResources  | where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions'  | project definitionId = tolower(id), type, numberOfPolicies = array_length(properties.policyDefinitions), category = tostring(properties.metadata.category), numberOfGroups= array_length(properties.policyDefinitionGroups), mode = tostring(properties.mode)  | extend isRegulatoryInitiative = iff(category =~ 'Regulatory Compliance', true, false)  | extend definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy')  | extend isRPMode = iff(mode startswith 'Microsoft.', true, false)  | project definitionId, numberOfPolicies, category, numberOfGroups, isRegulatoryInitiative, definitionType, isRPMode ) on $left.policyAssignmentDefinitionId == $right.definitionId | join kind=leftouter(  policyResources  | where type =~ 'Microsoft.PolicyInsights/PolicyStates'  | extend complianceState = tostring(properties.complianceState)  | extend policyStateResourceId =id, resourceId = tostring(properties.resourceId), policyAssignmentId = tostring(properties.policyAssignmentId), policyDefinitionId = tostring(properties.policyDefinitionId), policySetDefinitionId = tostring(properties.policySetDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), policyDefinitionAction = tostring(properties.policyDefinitionAction), policyDefinitionGroupNames = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic([''])), stateWeight = toint(properties.stateWeight)  | summarize max(stateWeight) by resourceId, policyAssignmentId, policySetDefinitionId  | summarize resourceCounts = count() by policyAssignmentId, policySetDefinitionId, max_stateWeight | extend complianceState = case( max_stateWeight == 300, 'noncompliant', max_stateWeight == 200, 'compliant', max_stateWeight == 100, 'conflict', max_stateWeight == 50, 'exempt', max_stateWeight == 10, 'unknown', 'notapplicable')  | extend pack = pack('complianceState', complianceState, 'resourceCounts', resourceCounts), numberOfNonCompliantResources = toint(iff(complianceState =~ 'NonCompliant', resourceCounts,0))  | summarize numberOfNonCompliantResources = max(numberOfNonCompliantResources), details = makelist(pack) by policyAssignmentId, policySetDefinitionId  | limit 5000 ) on $left.policyAssignmentId == $right.policyAssignmentId | sort by numberOfNonCompliantResources desc | project-away policyAssignmentId1"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "policyResources | where type =~'Microsoft.Authorization/PolicyAssignments' | project policyAssignmentId = tolower(tostring(id)), policyAssignmentName = name, policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentScope = tostring(properties.scope), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId), policyAssignmentNotScopes = tolower(properties.notScopes) | join kind=leftouter(  policyResources  | where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions'  | project definitionId = tolower(id), type, numberOfPolicies = array_length(properties.policyDefinitions), category = tostring(properties.metadata.category), numberOfGroups= array_length(properties.policyDefinitionGroups), mode = tostring(properties.mode)  | extend isRegulatoryInitiative = iff(category =~ 'Regulatory Compliance', true, false)  | extend definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy')  | extend isRPMode = iff(mode startswith 'Microsoft.', true, false)  | project definitionId, numberOfPolicies, category, numberOfGroups, isRegulatoryInitiative, definitionType, isRPMode ) on $left.policyAssignmentDefinitionId == $right.definitionId | join kind=leftouter(  policyResources  | where type =~ 'Microsoft.PolicyInsights/PolicyStates'  | extend complianceState = tostring(properties.complianceState)  | extend policyStateResourceId =id, resourceId = tostring(properties.resourceId), policyAssignmentId = tostring(properties.policyAssignmentId), policyDefinitionId = tostring(properties.policyDefinitionId), policySetDefinitionId = tostring(properties.policySetDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), policyDefinitionAction = tostring(properties.policyDefinitionAction), policyDefinitionGroupNames = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic([''])), stateWeight = toint(properties.stateWeight)  | summarize max(stateWeight) by resourceId, policyAssignmentId, policySetDefinitionId  | summarize resourceCounts = count() by policyAssignmentId, policySetDefinitionId, max_stateWeight | extend complianceState = case( max_stateWeight == 300, 'noncompliant', max_stateWeight == 200, 'compliant', max_stateWeight == 100, 'conflict', max_stateWeight == 50, 'exempt', max_stateWeight == 10, 'unknown', 'notapplicable')  | extend pack = pack('complianceState', complianceState, 'resourceCounts', resourceCounts), numberOfNonCompliantResources = toint(iff(complianceState =~ 'NonCompliant', resourceCounts,0))  | summarize numberOfNonCompliantResources = max(numberOfNonCompliantResources), details = makelist(pack) by policyAssignmentId, policySetDefinitionId  | limit 5000 ) on $left.policyAssignmentId == $right.policyAssignmentId | sort by numberOfNonCompliantResources desc | project-away policyAssignmentId1"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%20%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentName%20%3D%20name%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentScope%20%3D%20tostring%28properties.scope%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%2C%20policyAssignmentNotScopes%20%3D%20tolower%28properties.notScopes%29%20%7C%20join%20kind%3Dleftouter%28%20%20policyResources%20%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%20%20%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20type%2C%20numberOfPolicies%20%3D%20array_length%28properties.policyDefinitions%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20numberOfGroups%3D%20array_length%28properties.policyDefinitionGroups%29%2C%20mode%20%3D%20tostring%28properties.mode%29%20%20%7C%20extend%20isRegulatoryInitiative%20%3D%20iff%28category%20%3D~%20%27Regulatory%20Compliance%27%2C%20true%2C%20false%29%20%20%7C%20extend%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%20%20%7C%20extend%20isRPMode%20%3D%20iff%28mode%20startswith%20%27Microsoft.%27%2C%20true%2C%20false%29%20%20%7C%20project%20definitionId%2C%20numberOfPolicies%2C%20category%2C%20numberOfGroups%2C%20isRegulatoryInitiative%2C%20definitionType%2C%20isRPMode%20%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId%20%7C%20join%20kind%3Dleftouter%28%20%20policyResources%20%20%7C%20where%20type%20%3D~%20%27Microsoft.PolicyInsights%2FPolicyStates%27%20%20%7C%20extend%20complianceState%20%3D%20tostring%28properties.complianceState%29%20%20%7C%20extend%20policyStateResourceId%20%3Did%2C%20resourceId%20%3D%20tostring%28properties.resourceId%29%2C%20policyAssignmentId%20%3D%20tostring%28properties.policyAssignmentId%29%2C%20policyDefinitionId%20%3D%20tostring%28properties.policyDefinitionId%29%2C%20policySetDefinitionId%20%3D%20tostring%28properties.policySetDefinitionId%29%2C%20policyDefinitionReferenceId%20%3D%20tostring%28properties.policyDefinitionReferenceId%29%2C%20policyDefinitionAction%20%3D%20tostring%28properties.policyDefinitionAction%29%2C%20policyDefinitionGroupNames%20%3D%20iff%28isnotnull%28properties.policyDefinitionGroupNames%29%2C%20properties.policyDefinitionGroupNames%2C%20dynamic%28%5B%27%27%5D%29%29%2C%20stateWeight%20%3D%20toint%28properties.stateWeight%29%20%20%7C%20summarize%20max%28stateWeight%29%20by%20resourceId%2C%20policyAssignmentId%2C%20policySetDefinitionId%20%20%7C%20summarize%20resourceCounts%20%3D%20count%28%29%20by%20policyAssignmentId%2C%20policySetDefinitionId%2C%20max_stateWeight%20%7C%20extend%20complianceState%20%3D%20case%28%20max_stateWeight%20%3D%3D%20300%2C%20%27noncompliant%27%2C%20max_stateWeight%20%3D%3D%20200%2C%20%27compliant%27%2C%20max_stateWeight%20%3D%3D%20100%2C%20%27conflict%27%2C%20max_stateWeight%20%3D%3D%2050%2C%20%27exempt%27%2C%20max_stateWeight%20%3D%3D%2010%2C%20%27unknown%27%2C%20%27notapplicable%27%29%20%20%7C%20extend%20pack%20%3D%20pack%28%27complianceState%27%2C%20complianceState%2C%20%27resourceCounts%27%2C%20resourceCounts%29%2C%20numberOfNonCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27NonCompliant%27%2C%20resourceCounts%2C0%29%29%20%20%7C%20summarize%20numberOfNonCompliantResources%20%3D%20max%28numberOfNonCompliantResources%29%2C%20details%20%3D%20makelist%28pack%29%20by%20policyAssignmentId%2C%20policySetDefinitionId%20%20%7C%20limit%205000%20%29%20on%20%24left.policyAssignmentId%20%3D%3D%20%24right.policyAssignmentId%20%7C%20sort%20by%20numberOfNonCompliantResources%20desc%20%7C%20project-away%20policyAssignmentId1" target="_blank">portal.Azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%20%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentName%20%3D%20name%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentScope%20%3D%20tostring%28properties.scope%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%2C%20policyAssignmentNotScopes%20%3D%20tolower%28properties.notScopes%29%20%7C%20join%20kind%3Dleftouter%28%20%20policyResources%20%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%20%20%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20type%2C%20numberOfPolicies%20%3D%20array_length%28properties.policyDefinitions%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20numberOfGroups%3D%20array_length%28properties.policyDefinitionGroups%29%2C%20mode%20%3D%20tostring%28properties.mode%29%20%20%7C%20extend%20isRegulatoryInitiative%20%3D%20iff%28category%20%3D~%20%27Regulatory%20Compliance%27%2C%20true%2C%20false%29%20%20%7C%20extend%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%20%20%7C%20extend%20isRPMode%20%3D%20iff%28mode%20startswith%20%27Microsoft.%27%2C%20true%2C%20false%29%20%20%7C%20project%20definitionId%2C%20numberOfPolicies%2C%20category%2C%20numberOfGroups%2C%20isRegulatoryInitiative%2C%20definitionType%2C%20isRPMode%20%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId%20%7C%20join%20kind%3Dleftouter%28%20%20policyResources%20%20%7C%20where%20type%20%3D~%20%27Microsoft.PolicyInsights%2FPolicyStates%27%20%20%7C%20extend%20complianceState%20%3D%20tostring%28properties.complianceState%29%20%20%7C%20extend%20policyStateResourceId%20%3Did%2C%20resourceId%20%3D%20tostring%28properties.resourceId%29%2C%20policyAssignmentId%20%3D%20tostring%28properties.policyAssignmentId%29%2C%20policyDefinitionId%20%3D%20tostring%28properties.policyDefinitionId%29%2C%20policySetDefinitionId%20%3D%20tostring%28properties.policySetDefinitionId%29%2C%20policyDefinitionReferenceId%20%3D%20tostring%28properties.policyDefinitionReferenceId%29%2C%20policyDefinitionAction%20%3D%20tostring%28properties.policyDefinitionAction%29%2C%20policyDefinitionGroupNames%20%3D%20iff%28isnotnull%28properties.policyDefinitionGroupNames%29%2C%20properties.policyDefinitionGroupNames%2C%20dynamic%28%5B%27%27%5D%29%29%2C%20stateWeight%20%3D%20toint%28properties.stateWeight%29%20%20%7C%20summarize%20max%28stateWeight%29%20by%20resourceId%2C%20policyAssignmentId%2C%20policySetDefinitionId%20%20%7C%20summarize%20resourceCounts%20%3D%20count%28%29%20by%20policyAssignmentId%2C%20policySetDefinitionId%2C%20max_stateWeight%20%7C%20extend%20complianceState%20%3D%20case%28%20max_stateWeight%20%3D%3D%20300%2C%20%27noncompliant%27%2C%20max_stateWeight%20%3D%3D%20200%2C%20%27compliant%27%2C%20max_stateWeight%20%3D%3D%20100%2C%20%27conflict%27%2C%20max_stateWeight%20%3D%3D%2050%2C%20%27exempt%27%2C%20max_stateWeight%20%3D%3D%2010%2C%20%27unknown%27%2C%20%27notapplicable%27%29%20%20%7C%20extend%20pack%20%3D%20pack%28%27complianceState%27%2C%20complianceState%2C%20%27resourceCounts%27%2C%20resourceCounts%29%2C%20numberOfNonCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27NonCompliant%27%2C%20resourceCounts%2C0%29%29%20%20%7C%20summarize%20numberOfNonCompliantResources%20%3D%20max%28numberOfNonCompliantResources%29%2C%20details%20%3D%20makelist%28pack%29%20by%20policyAssignmentId%2C%20policySetDefinitionId%20%20%7C%20limit%205000%20%29%20on%20%24left.policyAssignmentId%20%3D%3D%20%24right.policyAssignmentId%20%7C%20sort%20by%20numberOfNonCompliantResources%20desc%20%7C%20project-away%20policyAssignmentId1" target="_blank">portal.Azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%20%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentName%20%3D%20name%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentScope%20%3D%20tostring%28properties.scope%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%2C%20policyAssignmentNotScopes%20%3D%20tolower%28properties.notScopes%29%20%7C%20join%20kind%3Dleftouter%28%20%20policyResources%20%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%20%20%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20type%2C%20numberOfPolicies%20%3D%20array_length%28properties.policyDefinitions%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20numberOfGroups%3D%20array_length%28properties.policyDefinitionGroups%29%2C%20mode%20%3D%20tostring%28properties.mode%29%20%20%7C%20extend%20isRegulatoryInitiative%20%3D%20iff%28category%20%3D~%20%27Regulatory%20Compliance%27%2C%20true%2C%20false%29%20%20%7C%20extend%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%20%20%7C%20extend%20isRPMode%20%3D%20iff%28mode%20startswith%20%27Microsoft.%27%2C%20true%2C%20false%29%20%20%7C%20project%20definitionId%2C%20numberOfPolicies%2C%20category%2C%20numberOfGroups%2C%20isRegulatoryInitiative%2C%20definitionType%2C%20isRPMode%20%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId%20%7C%20join%20kind%3Dleftouter%28%20%20policyResources%20%20%7C%20where%20type%20%3D~%20%27Microsoft.PolicyInsights%2FPolicyStates%27%20%20%7C%20extend%20complianceState%20%3D%20tostring%28properties.complianceState%29%20%20%7C%20extend%20policyStateResourceId%20%3Did%2C%20resourceId%20%3D%20tostring%28properties.resourceId%29%2C%20policyAssignmentId%20%3D%20tostring%28properties.policyAssignmentId%29%2C%20policyDefinitionId%20%3D%20tostring%28properties.policyDefinitionId%29%2C%20policySetDefinitionId%20%3D%20tostring%28properties.policySetDefinitionId%29%2C%20policyDefinitionReferenceId%20%3D%20tostring%28properties.policyDefinitionReferenceId%29%2C%20policyDefinitionAction%20%3D%20tostring%28properties.policyDefinitionAction%29%2C%20policyDefinitionGroupNames%20%3D%20iff%28isnotnull%28properties.policyDefinitionGroupNames%29%2C%20properties.policyDefinitionGroupNames%2C%20dynamic%28%5B%27%27%5D%29%29%2C%20stateWeight%20%3D%20toint%28properties.stateWeight%29%20%20%7C%20summarize%20max%28stateWeight%29%20by%20resourceId%2C%20policyAssignmentId%2C%20policySetDefinitionId%20%20%7C%20summarize%20resourceCounts%20%3D%20count%28%29%20by%20policyAssignmentId%2C%20policySetDefinitionId%2C%20max_stateWeight%20%7C%20extend%20complianceState%20%3D%20case%28%20max_stateWeight%20%3D%3D%20300%2C%20%27noncompliant%27%2C%20max_stateWeight%20%3D%3D%20200%2C%20%27compliant%27%2C%20max_stateWeight%20%3D%3D%20100%2C%20%27conflict%27%2C%20max_stateWeight%20%3D%3D%2050%2C%20%27exempt%27%2C%20max_stateWeight%20%3D%3D%2010%2C%20%27unknown%27%2C%20%27notapplicable%27%29%20%20%7C%20extend%20pack%20%3D%20pack%28%27complianceState%27%2C%20complianceState%2C%20%27resourceCounts%27%2C%20resourceCounts%29%2C%20numberOfNonCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27NonCompliant%27%2C%20resourceCounts%2C0%29%29%20%20%7C%20summarize%20numberOfNonCompliantResources%20%3D%20max%28numberOfNonCompliantResources%29%2C%20details%20%3D%20makelist%28pack%29%20by%20policyAssignmentId%2C%20policySetDefinitionId%20%20%7C%20limit%205000%20%29%20on%20%24left.policyAssignmentId%20%3D%3D%20%24right.policyAssignmentId%20%7C%20sort%20by%20numberOfNonCompliantResources%20desc%20%7C%20project-away%20policyAssignmentId1" target="_blank">portal.Azure.cn</a>

---

### Breakdown of compliance information for each policy within a given built-in or custom policySetDefinition

This sample query gets aggregated compliance information for each policy within a given policySetDefinition assigned to your environment. You'll see information like: policy definition payload, definition reference ID, policy definition parameters, policy definition effects, total resources evaluated for the definition, and number of resources evaluated to each of the compliance states.

```kusto
policyResources
| where type =~ 'Microsoft.Authorization/PolicySetDefinitions'
| where id =~ '/providers/microsoft.authorization/policysetdefinitions/setDefinitionId'
| extend policysetDefId = tolower(id)| extend policyDefinitions = properties.policyDefinitions
|  mv-expand policyDefinition = policyDefinitions limit 400
|  extend policyDefinitionId = tolower(policyDefinition.policyDefinitionId)
|  extend policyDefinitionReferenceId = tolower(policyDefinition.policyDefinitionReferenceId)
|  extend policyDefinitionReferenceParameters = policyDefinition.parameters
|  extend groupNames = policyDefinition.groupNames
|  join kind = leftouter(
 policyResources
 |  where type =~ 'Microsoft.Authorization/Policydefinitions'
 |  extend policyDefinitionId = tolower(id)) on $left.policyDefinitionId == $right.policyDefinitionId
 |  project id = tolower(id1), name = name1, properties = properties1, policyDefinitionReferenceId = tolower(policyDefinitionReferenceId), policyDefinitionReferenceParameters, groupNames
 | join kind = leftouter(
 policyResources
 |  where type =~ 'Microsoft.PolicyInsights/PolicyStates'
 |  extend resourceId = tostring(properties.resourceId)
 |  extend complianceState = tostring(properties.complianceState)
 |  extend policyAssignmentId = tostring(properties.policyAssignmentId),
policyDefinitionId = tostring(properties.policyDefinitionId),
policySetDefinitionId = tostring(properties.policySetDefinitionId),
policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId),
policyDefinitionAction = tostring(properties.policyDefinitionAction),
policyDefinitionGroupNames = iff(isnotnull(properties.policyDefinitionGroupNames),
properties.policyDefinitionGroupNames, dynamic([''])),
stateWeight = case(
complianceState == 'Noncompliant', 300,
complianceState == 'Compliant', 200,
complianceState == 'Conflict', 100,
complianceState == 'Exempt', 500,
complianceState == 'Unknown', 10,
0)
 |  where policyAssignmentId  =~ '/subscriptions/subscriptionId/providers/microsoft.authorization/policyassignments/policyInitiativeName'
 |  summarize resourceCounts = count() by policyAssignmentId, policyDefinitionId, policyDefinitionReferenceId, tostring(policyDefinitionGroupNames), policyDefinitionAction, complianceState
 |  extend Pack = pack('complianceState', complianceState, 'resourceCounts', resourceCounts), numberOfNonCompliantResources = toint(iff(complianceState =~ 'NonCompliant', resourceCounts, 0)),  numberOfCompliantResources = toint(iff(complianceState =~ 'Compliant', resourceCounts, 0)),  numberOfConflictResources = toint(iff(complianceState =~ 'Conflict', resourceCounts, 0)),  numberOfExemptResources = toint(iff(complianceState =~ 'Exempt', resourceCounts, 0)),  numberOfUnknownResources = toint(iff(complianceState =~ 'Unknown', resourceCounts, 0))
 |  extend totalResources = todouble(numberOfNonCompliantResources + numberOfCompliantResources + numberOfConflictResources + numberOfExemptResources + numberOfUnknownResources)
 |  summarize numberOfNonCompliantResources = max(numberOfNonCompliantResources), numberOfCompliantResources=max(numberOfCompliantResources), numberOfConflictResources=max(numberOfConflictResources), numberOfExemptResources =max(numberOfExemptResources), numberOfUnknownResources = max(numberOfUnknownResources), totalResources=sum(totalResources), details = makelist(Pack) by policyAssignmentId, policyDefinitionId, policyDefinitionReferenceId, policyDefinitionGroupNames, policyDefinitionAction
 |  order by numberOfNonCompliantResources desc, policyAssignmentId asc
 |  limit 5000     ) on $left.id == $right.policyDefinitionId and $left.policyDefinitionReferenceId == $right.policyDefinitionReferenceId
 |  project-away policyDefinitionReferenceId1
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "policyResources | where type =~ 'Microsoft.Authorization/PolicySetDefinitions' | where id =~ '/providers/microsoft.authorization/policysetdefinitions/setDefinitionId' | extend policysetDefId = tolower(id)| extend policyDefinitions = properties.policyDefinitions |  mv-expand policyDefinition = policyDefinitions limit 400 |  extend policyDefinitionId = tolower(policyDefinition.policyDefinitionId) |  extend policyDefinitionReferenceId = tolower(policyDefinition.policyDefinitionReferenceId) |  extend policyDefinitionReferenceParameters = policyDefinition.parameters |  extend groupNames = policyDefinition.groupNames |  join kind = leftouter(  policyResources  |  where type =~ 'Microsoft.Authorization/Policydefinitions'  |  extend policyDefinitionId = tolower(id)) on $left.policyDefinitionId == $right.policyDefinitionId  |  project id = tolower(id1), name = name1, properties = properties1, policyDefinitionReferenceId = tolower(policyDefinitionReferenceId), policyDefinitionReferenceParameters, groupNames  | join kind = leftouter(  policyResources  |  where type =~ 'Microsoft.PolicyInsights/PolicyStates'  |  extend resourceId = tostring(properties.resourceId)  |  extend complianceState = tostring(properties.complianceState)  |  extend policyAssignmentId = tostring(properties.policyAssignmentId), policyDefinitionId = tostring(properties.policyDefinitionId), policySetDefinitionId = tostring(properties.policySetDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), policyDefinitionAction = tostring(properties.policyDefinitionAction), policyDefinitionGroupNames = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic([''])), stateWeight = case( complianceState == 'Noncompliant', 300, complianceState == 'Compliant', 200, complianceState == 'Conflict', 100, complianceState == 'Exempt', 500, complianceState == 'Unknown', 10, 0)  |  where policyAssignmentId  =~ '/subscriptions/subscriptionId/providers/microsoft.authorization/policyassignments/policyInitiativeName'  |  summarize resourceCounts = count() by policyAssignmentId, policyDefinitionId, policyDefinitionReferenceId, tostring(policyDefinitionGroupNames), policyDefinitionAction, complianceState  |  extend Pack = pack('complianceState', complianceState, 'resourceCounts', resourceCounts), numberOfNonCompliantResources = toint(iff(complianceState =~ 'NonCompliant', resourceCounts, 0)),  numberOfCompliantResources = toint(iff(complianceState =~ 'Compliant', resourceCounts, 0)),  numberOfConflictResources = toint(iff(complianceState =~ 'Conflict', resourceCounts, 0)),  numberOfExemptResources = toint(iff(complianceState =~ 'Exempt', resourceCounts, 0)),  numberOfUnknownResources = toint(iff(complianceState =~ 'Unknown', resourceCounts, 0))  |  extend totalResources = todouble(numberOfNonCompliantResources + numberOfCompliantResources + numberOfConflictResources + numberOfExemptResources + numberOfUnknownResources)  |  summarize numberOfNonCompliantResources = max(numberOfNonCompliantResources), numberOfCompliantResources=max(numberOfCompliantResources), numberOfConflictResources=max(numberOfConflictResources), numberOfExemptResources =max(numberOfExemptResources), numberOfUnknownResources = max(numberOfUnknownResources), totalResources=sum(totalResources), details = makelist(Pack) by policyAssignmentId, policyDefinitionId, policyDefinitionReferenceId, policyDefinitionGroupNames, policyDefinitionAction  |  order by numberOfNonCompliantResources desc, policyAssignmentId asc  |  limit 5000     ) on $left.id == $right.policyDefinitionId and $left.policyDefinitionReferenceId == $right.policyDefinitionReferenceId  |  project-away policyDefinitionReferenceId1"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "policyResources | where type =~ 'Microsoft.Authorization/PolicySetDefinitions' | where id =~ '/providers/microsoft.authorization/policysetdefinitions/setDefinitionId' | extend policysetDefId = tolower(id)| extend policyDefinitions = properties.policyDefinitions |  mv-expand policyDefinition = policyDefinitions limit 400 |  extend policyDefinitionId = tolower(policyDefinition.policyDefinitionId) |  extend policyDefinitionReferenceId = tolower(policyDefinition.policyDefinitionReferenceId) |  extend policyDefinitionReferenceParameters = policyDefinition.parameters |  extend groupNames = policyDefinition.groupNames |  join kind = leftouter(  policyResources  |  where type =~ 'Microsoft.Authorization/Policydefinitions'  |  extend policyDefinitionId = tolower(id)) on $left.policyDefinitionId == $right.policyDefinitionId  |  project id = tolower(id1), name = name1, properties = properties1, policyDefinitionReferenceId = tolower(policyDefinitionReferenceId), policyDefinitionReferenceParameters, groupNames  | join kind = leftouter(  policyResources  |  where type =~ 'Microsoft.PolicyInsights/PolicyStates'  |  extend resourceId = tostring(properties.resourceId)  |  extend complianceState = tostring(properties.complianceState)  |  extend policyAssignmentId = tostring(properties.policyAssignmentId), policyDefinitionId = tostring(properties.policyDefinitionId), policySetDefinitionId = tostring(properties.policySetDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), policyDefinitionAction = tostring(properties.policyDefinitionAction), policyDefinitionGroupNames = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic([''])), stateWeight = case( complianceState == 'Noncompliant', 300, complianceState == 'Compliant', 200, complianceState == 'Conflict', 100, complianceState == 'Exempt', 500, complianceState == 'Unknown', 10, 0)  |  where policyAssignmentId  =~ '/subscriptions/subscriptionId/providers/microsoft.authorization/policyassignments/policyInitiativeName'  |  summarize resourceCounts = count() by policyAssignmentId, policyDefinitionId, policyDefinitionReferenceId, tostring(policyDefinitionGroupNames), policyDefinitionAction, complianceState  |  extend Pack = pack('complianceState', complianceState, 'resourceCounts', resourceCounts), numberOfNonCompliantResources = toint(iff(complianceState =~ 'NonCompliant', resourceCounts, 0)),  numberOfCompliantResources = toint(iff(complianceState =~ 'Compliant', resourceCounts, 0)),  numberOfConflictResources = toint(iff(complianceState =~ 'Conflict', resourceCounts, 0)),  numberOfExemptResources = toint(iff(complianceState =~ 'Exempt', resourceCounts, 0)),  numberOfUnknownResources = toint(iff(complianceState =~ 'Unknown', resourceCounts, 0))  |  extend totalResources = todouble(numberOfNonCompliantResources + numberOfCompliantResources + numberOfConflictResources + numberOfExemptResources + numberOfUnknownResources)  |  summarize numberOfNonCompliantResources = max(numberOfNonCompliantResources), numberOfCompliantResources=max(numberOfCompliantResources), numberOfConflictResources=max(numberOfConflictResources), numberOfExemptResources =max(numberOfExemptResources), numberOfUnknownResources = max(numberOfUnknownResources), totalResources=sum(totalResources), details = makelist(Pack) by policyAssignmentId, policyDefinitionId, policyDefinitionReferenceId, policyDefinitionGroupNames, policyDefinitionAction  |  order by numberOfNonCompliantResources desc, policyAssignmentId asc  |  limit 5000     ) on $left.id == $right.policyDefinitionId and $left.policyDefinitionReferenceId == $right.policyDefinitionReferenceId  |  project-away policyDefinitionReferenceId1"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%20%7C%20where%20type%20%3D~%20%27Microsoft.Authorization%2FPolicySetDefinitions%27%20%7C%20where%20id%20%3D~%20%27%2Fproviders%2Fmicrosoft.authorization%2Fpolicysetdefinitions%2FsetDefinitionId%27%20%7C%20extend%20policysetDefId%20%3D%20tolower%28id%29%7C%20extend%20policyDefinitions%20%3D%20properties.policyDefinitions%20%7C%20%20mv-expand%20policyDefinition%20%3D%20policyDefinitions%20limit%20400%20%7C%20%20extend%20policyDefinitionId%20%3D%20tolower%28policyDefinition.policyDefinitionId%29%20%7C%20%20extend%20policyDefinitionReferenceId%20%3D%20tolower%28policyDefinition.policyDefinitionReferenceId%29%20%7C%20%20extend%20policyDefinitionReferenceParameters%20%3D%20policyDefinition.parameters%20%7C%20%20extend%20groupNames%20%3D%20policyDefinition.groupNames%20%7C%20%20join%20kind%20%3D%20leftouter%28%20%20policyResources%20%20%7C%20%20where%20type%20%3D~%20%27Microsoft.Authorization%2FPolicydefinitions%27%20%20%7C%20%20extend%20policyDefinitionId%20%3D%20tolower%28id%29%29%20on%20%24left.policyDefinitionId%20%3D%3D%20%24right.policyDefinitionId%20%20%7C%20%20project%20id%20%3D%20tolower%28id1%29%2C%20name%20%3D%20name1%2C%20properties%20%3D%20properties1%2C%20policyDefinitionReferenceId%20%3D%20tolower%28policyDefinitionReferenceId%29%2C%20policyDefinitionReferenceParameters%2C%20groupNames%20%20%7C%20join%20kind%20%3D%20leftouter%28%20%20policyResources%20%20%7C%20%20where%20type%20%3D~%20%27Microsoft.PolicyInsights%2FPolicyStates%27%20%20%7C%20%20extend%20resourceId%20%3D%20tostring%28properties.resourceId%29%20%20%7C%20%20extend%20complianceState%20%3D%20tostring%28properties.complianceState%29%20%20%7C%20%20extend%20policyAssignmentId%20%3D%20tostring%28properties.policyAssignmentId%29%2C%20policyDefinitionId%20%3D%20tostring%28properties.policyDefinitionId%29%2C%20policySetDefinitionId%20%3D%20tostring%28properties.policySetDefinitionId%29%2C%20policyDefinitionReferenceId%20%3D%20tostring%28properties.policyDefinitionReferenceId%29%2C%20policyDefinitionAction%20%3D%20tostring%28properties.policyDefinitionAction%29%2C%20policyDefinitionGroupNames%20%3D%20iff%28isnotnull%28properties.policyDefinitionGroupNames%29%2C%20properties.policyDefinitionGroupNames%2C%20dynamic%28%5B%27%27%5D%29%29%2C%20stateWeight%20%3D%20case%28%20complianceState%20%3D%3D%20%27Noncompliant%27%2C%20300%2C%20complianceState%20%3D%3D%20%27Compliant%27%2C%20200%2C%20complianceState%20%3D%3D%20%27Conflict%27%2C%20100%2C%20complianceState%20%3D%3D%20%27Exempt%27%2C%20500%2C%20complianceState%20%3D%3D%20%27Unknown%27%2C%2010%2C%200%29%20%20%7C%20%20where%20policyAssignmentId%20%20%3D~%20%27%2Fsubscriptions%2FsubscriptionId%2Fproviders%2Fmicrosoft.authorization%2Fpolicyassignments%2FpolicyInitiativeName%27%20%20%7C%20%20summarize%20resourceCounts%20%3D%20count%28%29%20by%20policyAssignmentId%2C%20policyDefinitionId%2C%20policyDefinitionReferenceId%2C%20tostring%28policyDefinitionGroupNames%29%2C%20policyDefinitionAction%2C%20complianceState%20%20%7C%20%20extend%20Pack%20%3D%20pack%28%27complianceState%27%2C%20complianceState%2C%20%27resourceCounts%27%2C%20resourceCounts%29%2C%20numberOfNonCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27NonCompliant%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Compliant%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfConflictResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Conflict%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfExemptResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Exempt%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfUnknownResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Unknown%27%2C%20resourceCounts%2C%200%29%29%20%20%7C%20%20extend%20totalResources%20%3D%20todouble%28numberOfNonCompliantResources%20%2B%20numberOfCompliantResources%20%2B%20numberOfConflictResources%20%2B%20numberOfExemptResources%20%2B%20numberOfUnknownResources%29%20%20%7C%20%20summarize%20numberOfNonCompliantResources%20%3D%20max%28numberOfNonCompliantResources%29%2C%20numberOfCompliantResources%3Dmax%28numberOfCompliantResources%29%2C%20numberOfConflictResources%3Dmax%28numberOfConflictResources%29%2C%20numberOfExemptResources%20%3Dmax%28numberOfExemptResources%29%2C%20numberOfUnknownResources%20%3D%20max%28numberOfUnknownResources%29%2C%20totalResources%3Dsum%28totalResources%29%2C%20details%20%3D%20makelist%28Pack%29%20by%20policyAssignmentId%2C%20policyDefinitionId%2C%20policyDefinitionReferenceId%2C%20policyDefinitionGroupNames%2C%20policyDefinitionAction%20%20%7C%20%20order%20by%20numberOfNonCompliantResources%20desc%2C%20policyAssignmentId%20asc%20%20%7C%20%20limit%205000%20%20%20%20%20%29%20on%20%24left.id%20%3D%3D%20%24right.policyDefinitionId%20and%20%24left.policyDefinitionReferenceId%20%3D%3D%20%24right.policyDefinitionReferenceId%20%20%7C%20%20project-away%20policyDefinitionReferenceId1" target="_blank">portal.Azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%20%7C%20where%20type%20%3D~%20%27Microsoft.Authorization%2FPolicySetDefinitions%27%20%7C%20where%20id%20%3D~%20%27%2Fproviders%2Fmicrosoft.authorization%2Fpolicysetdefinitions%2FsetDefinitionId%27%20%7C%20extend%20policysetDefId%20%3D%20tolower%28id%29%7C%20extend%20policyDefinitions%20%3D%20properties.policyDefinitions%20%7C%20%20mv-expand%20policyDefinition%20%3D%20policyDefinitions%20limit%20400%20%7C%20%20extend%20policyDefinitionId%20%3D%20tolower%28policyDefinition.policyDefinitionId%29%20%7C%20%20extend%20policyDefinitionReferenceId%20%3D%20tolower%28policyDefinition.policyDefinitionReferenceId%29%20%7C%20%20extend%20policyDefinitionReferenceParameters%20%3D%20policyDefinition.parameters%20%7C%20%20extend%20groupNames%20%3D%20policyDefinition.groupNames%20%7C%20%20join%20kind%20%3D%20leftouter%28%20%20policyResources%20%20%7C%20%20where%20type%20%3D~%20%27Microsoft.Authorization%2FPolicydefinitions%27%20%20%7C%20%20extend%20policyDefinitionId%20%3D%20tolower%28id%29%29%20on%20%24left.policyDefinitionId%20%3D%3D%20%24right.policyDefinitionId%20%20%7C%20%20project%20id%20%3D%20tolower%28id1%29%2C%20name%20%3D%20name1%2C%20properties%20%3D%20properties1%2C%20policyDefinitionReferenceId%20%3D%20tolower%28policyDefinitionReferenceId%29%2C%20policyDefinitionReferenceParameters%2C%20groupNames%20%20%7C%20join%20kind%20%3D%20leftouter%28%20%20policyResources%20%20%7C%20%20where%20type%20%3D~%20%27Microsoft.PolicyInsights%2FPolicyStates%27%20%20%7C%20%20extend%20resourceId%20%3D%20tostring%28properties.resourceId%29%20%20%7C%20%20extend%20complianceState%20%3D%20tostring%28properties.complianceState%29%20%20%7C%20%20extend%20policyAssignmentId%20%3D%20tostring%28properties.policyAssignmentId%29%2C%20policyDefinitionId%20%3D%20tostring%28properties.policyDefinitionId%29%2C%20policySetDefinitionId%20%3D%20tostring%28properties.policySetDefinitionId%29%2C%20policyDefinitionReferenceId%20%3D%20tostring%28properties.policyDefinitionReferenceId%29%2C%20policyDefinitionAction%20%3D%20tostring%28properties.policyDefinitionAction%29%2C%20policyDefinitionGroupNames%20%3D%20iff%28isnotnull%28properties.policyDefinitionGroupNames%29%2C%20properties.policyDefinitionGroupNames%2C%20dynamic%28%5B%27%27%5D%29%29%2C%20stateWeight%20%3D%20case%28%20complianceState%20%3D%3D%20%27Noncompliant%27%2C%20300%2C%20complianceState%20%3D%3D%20%27Compliant%27%2C%20200%2C%20complianceState%20%3D%3D%20%27Conflict%27%2C%20100%2C%20complianceState%20%3D%3D%20%27Exempt%27%2C%20500%2C%20complianceState%20%3D%3D%20%27Unknown%27%2C%2010%2C%200%29%20%20%7C%20%20where%20policyAssignmentId%20%20%3D~%20%27%2Fsubscriptions%2FsubscriptionId%2Fproviders%2Fmicrosoft.authorization%2Fpolicyassignments%2FpolicyInitiativeName%27%20%20%7C%20%20summarize%20resourceCounts%20%3D%20count%28%29%20by%20policyAssignmentId%2C%20policyDefinitionId%2C%20policyDefinitionReferenceId%2C%20tostring%28policyDefinitionGroupNames%29%2C%20policyDefinitionAction%2C%20complianceState%20%20%7C%20%20extend%20Pack%20%3D%20pack%28%27complianceState%27%2C%20complianceState%2C%20%27resourceCounts%27%2C%20resourceCounts%29%2C%20numberOfNonCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27NonCompliant%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Compliant%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfConflictResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Conflict%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfExemptResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Exempt%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfUnknownResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Unknown%27%2C%20resourceCounts%2C%200%29%29%20%20%7C%20%20extend%20totalResources%20%3D%20todouble%28numberOfNonCompliantResources%20%2B%20numberOfCompliantResources%20%2B%20numberOfConflictResources%20%2B%20numberOfExemptResources%20%2B%20numberOfUnknownResources%29%20%20%7C%20%20summarize%20numberOfNonCompliantResources%20%3D%20max%28numberOfNonCompliantResources%29%2C%20numberOfCompliantResources%3Dmax%28numberOfCompliantResources%29%2C%20numberOfConflictResources%3Dmax%28numberOfConflictResources%29%2C%20numberOfExemptResources%20%3Dmax%28numberOfExemptResources%29%2C%20numberOfUnknownResources%20%3D%20max%28numberOfUnknownResources%29%2C%20totalResources%3Dsum%28totalResources%29%2C%20details%20%3D%20makelist%28Pack%29%20by%20policyAssignmentId%2C%20policyDefinitionId%2C%20policyDefinitionReferenceId%2C%20policyDefinitionGroupNames%2C%20policyDefinitionAction%20%20%7C%20%20order%20by%20numberOfNonCompliantResources%20desc%2C%20policyAssignmentId%20asc%20%20%7C%20%20limit%205000%20%20%20%20%20%29%20on%20%24left.id%20%3D%3D%20%24right.policyDefinitionId%20and%20%24left.policyDefinitionReferenceId%20%3D%3D%20%24right.policyDefinitionReferenceId%20%20%7C%20%20project-away%20policyDefinitionReferenceId1" target="_blank">portal.Azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%20%7C%20where%20type%20%3D~%20%27Microsoft.Authorization%2FPolicySetDefinitions%27%20%7C%20where%20id%20%3D~%20%27%2Fproviders%2Fmicrosoft.authorization%2Fpolicysetdefinitions%2FsetDefinitionId%27%20%7C%20extend%20policysetDefId%20%3D%20tolower%28id%29%7C%20extend%20policyDefinitions%20%3D%20properties.policyDefinitions%20%7C%20%20mv-expand%20policyDefinition%20%3D%20policyDefinitions%20limit%20400%20%7C%20%20extend%20policyDefinitionId%20%3D%20tolower%28policyDefinition.policyDefinitionId%29%20%7C%20%20extend%20policyDefinitionReferenceId%20%3D%20tolower%28policyDefinition.policyDefinitionReferenceId%29%20%7C%20%20extend%20policyDefinitionReferenceParameters%20%3D%20policyDefinition.parameters%20%7C%20%20extend%20groupNames%20%3D%20policyDefinition.groupNames%20%7C%20%20join%20kind%20%3D%20leftouter%28%20%20policyResources%20%20%7C%20%20where%20type%20%3D~%20%27Microsoft.Authorization%2FPolicydefinitions%27%20%20%7C%20%20extend%20policyDefinitionId%20%3D%20tolower%28id%29%29%20on%20%24left.policyDefinitionId%20%3D%3D%20%24right.policyDefinitionId%20%20%7C%20%20project%20id%20%3D%20tolower%28id1%29%2C%20name%20%3D%20name1%2C%20properties%20%3D%20properties1%2C%20policyDefinitionReferenceId%20%3D%20tolower%28policyDefinitionReferenceId%29%2C%20policyDefinitionReferenceParameters%2C%20groupNames%20%20%7C%20join%20kind%20%3D%20leftouter%28%20%20policyResources%20%20%7C%20%20where%20type%20%3D~%20%27Microsoft.PolicyInsights%2FPolicyStates%27%20%20%7C%20%20extend%20resourceId%20%3D%20tostring%28properties.resourceId%29%20%20%7C%20%20extend%20complianceState%20%3D%20tostring%28properties.complianceState%29%20%20%7C%20%20extend%20policyAssignmentId%20%3D%20tostring%28properties.policyAssignmentId%29%2C%20policyDefinitionId%20%3D%20tostring%28properties.policyDefinitionId%29%2C%20policySetDefinitionId%20%3D%20tostring%28properties.policySetDefinitionId%29%2C%20policyDefinitionReferenceId%20%3D%20tostring%28properties.policyDefinitionReferenceId%29%2C%20policyDefinitionAction%20%3D%20tostring%28properties.policyDefinitionAction%29%2C%20policyDefinitionGroupNames%20%3D%20iff%28isnotnull%28properties.policyDefinitionGroupNames%29%2C%20properties.policyDefinitionGroupNames%2C%20dynamic%28%5B%27%27%5D%29%29%2C%20stateWeight%20%3D%20case%28%20complianceState%20%3D%3D%20%27Noncompliant%27%2C%20300%2C%20complianceState%20%3D%3D%20%27Compliant%27%2C%20200%2C%20complianceState%20%3D%3D%20%27Conflict%27%2C%20100%2C%20complianceState%20%3D%3D%20%27Exempt%27%2C%20500%2C%20complianceState%20%3D%3D%20%27Unknown%27%2C%2010%2C%200%29%20%20%7C%20%20where%20policyAssignmentId%20%20%3D~%20%27%2Fsubscriptions%2FsubscriptionId%2Fproviders%2Fmicrosoft.authorization%2Fpolicyassignments%2FpolicyInitiativeName%27%20%20%7C%20%20summarize%20resourceCounts%20%3D%20count%28%29%20by%20policyAssignmentId%2C%20policyDefinitionId%2C%20policyDefinitionReferenceId%2C%20tostring%28policyDefinitionGroupNames%29%2C%20policyDefinitionAction%2C%20complianceState%20%20%7C%20%20extend%20Pack%20%3D%20pack%28%27complianceState%27%2C%20complianceState%2C%20%27resourceCounts%27%2C%20resourceCounts%29%2C%20numberOfNonCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27NonCompliant%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Compliant%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfConflictResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Conflict%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfExemptResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Exempt%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfUnknownResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Unknown%27%2C%20resourceCounts%2C%200%29%29%20%20%7C%20%20extend%20totalResources%20%3D%20todouble%28numberOfNonCompliantResources%20%2B%20numberOfCompliantResources%20%2B%20numberOfConflictResources%20%2B%20numberOfExemptResources%20%2B%20numberOfUnknownResources%29%20%20%7C%20%20summarize%20numberOfNonCompliantResources%20%3D%20max%28numberOfNonCompliantResources%29%2C%20numberOfCompliantResources%3Dmax%28numberOfCompliantResources%29%2C%20numberOfConflictResources%3Dmax%28numberOfConflictResources%29%2C%20numberOfExemptResources%20%3Dmax%28numberOfExemptResources%29%2C%20numberOfUnknownResources%20%3D%20max%28numberOfUnknownResources%29%2C%20totalResources%3Dsum%28totalResources%29%2C%20details%20%3D%20makelist%28Pack%29%20by%20policyAssignmentId%2C%20policyDefinitionId%2C%20policyDefinitionReferenceId%2C%20policyDefinitionGroupNames%2C%20policyDefinitionAction%20%20%7C%20%20order%20by%20numberOfNonCompliantResources%20desc%2C%20policyAssignmentId%20asc%20%20%7C%20%20limit%205000%20%20%20%20%20%29%20on%20%24left.id%20%3D%3D%20%24right.policyDefinitionId%20and%20%24left.policyDefinitionReferenceId%20%3D%3D%20%24right.policyDefinitionReferenceId%20%20%7C%20%20project-away%20policyDefinitionReferenceId1" target="_blank">portal.Azure.cn</a>

---

### Get all the compliance information for a specific scenario

The below sample query gets compliance information for storage accounts based on a specific tag.

```kusto
resources
| where type =~ "Microsoft.Storage/storageAccounts"
| where tags['clusterName'] =~ 'tagname'
| extend storageAccountId = tolower(id)
| join kind=leftouter(
    policyresources
    | where ['type'] =~ "Microsoft.PolicyInsights/policyStates"
    | project storageAccountId = tolower(properties.resourceId), policyStatesProperties = properties, resourceType = tostring(properties.resourceType)
) on $left.storageAccountId == $right.storageAccountId
| project-away storageAccountId, storageAccountId1
| extend policyAssignmentId = tostring(policyStatesProperties.policyAssignmentId),
  policyAssignmentName = tostring(policyStatesProperties.policyAssignmentName),
  policyDefinitionId = tostring(policyStatesProperties.policyDefinitionId),
  policyDefinitionName = tostring(policyStatesProperties.policyDefinitionName),
  policySetDefinitionName = tostring(policyStatesProperties.policySetDefinitionName),
  evaluationTime = tostring(policyStatesProperties.timestamp),
  complianceState = tostring(policyStatesProperties.complianceState)
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "resources  | where type =~ "Microsoft.Storage/storageAccounts"  | where tags['clusterName'] =~ 'tagname'  | extend storageAccountId = tolower(id)  | join kind=leftouter(      policyresources      | where ['type'] =~ "Microsoft.PolicyInsights/policyStates"      | project storageAccountId = tolower(properties.resourceId), policyStatesProperties = properties, resourceType = tostring(properties.resourceType)  ) on $left.storageAccountId == $right.storageAccountId  | project-away storageAccountId, storageAccountId1  | extend policyAssignmentId = tostring(policyStatesProperties.policyAssignmentId),    policyAssignmentName = tostring(policyStatesProperties.policyAssignmentName),    policyDefinitionId = tostring(policyStatesProperties.policyDefinitionId),    policyDefinitionName = tostring(policyStatesProperties.policyDefinitionName),    policySetDefinitionName = tostring(policyStatesProperties.policySetDefinitionName),    evaluationTime = tostring(policyStatesProperties.timestamp),    complianceState = tostring(policyStatesProperties.complianceState)"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "resources  | where type =~ "Microsoft.Storage/storageAccounts"  | where tags['clusterName'] =~ 'tagname'  | extend storageAccountId = tolower(id)  | join kind=leftouter(      policyresources      | where ['type'] =~ "Microsoft.PolicyInsights/policyStates"      | project storageAccountId = tolower(properties.resourceId), policyStatesProperties = properties, resourceType = tostring(properties.resourceType)  ) on $left.storageAccountId == $right.storageAccountId  | project-away storageAccountId, storageAccountId1  | extend policyAssignmentId = tostring(policyStatesProperties.policyAssignmentId),    policyAssignmentName = tostring(policyStatesProperties.policyAssignmentName),    policyDefinitionId = tostring(policyStatesProperties.policyDefinitionId),    policyDefinitionName = tostring(policyStatesProperties.policyDefinitionName),    policySetDefinitionName = tostring(policyStatesProperties.policySetDefinitionName),    evaluationTime = tostring(policyStatesProperties.timestamp),    complianceState = tostring(policyStatesProperties.complianceState)"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/resources%20%20%7C%20where%20type%20%3D~%20%22Microsoft.Storage%2FstorageAccounts%22%20%20%7C%20where%20tags%5B%27clusterName%27%5D%20%3D~%20%27tagname%27%20%20%7C%20extend%20storageAccountId%20%3D%20tolower%28id%29%20%20%7C%20join%20kind%3Dleftouter%28%20%20%20%20%20%20policyresources%20%20%20%20%20%20%7C%20where%20%5B%27type%27%5D%20%3D~%20%22Microsoft.PolicyInsights%2FpolicyStates%22%20%20%20%20%20%20%7C%20project%20storageAccountId%20%3D%20tolower%28properties.resourceId%29%2C%20policyStatesProperties%20%3D%20properties%2C%20resourceType%20%3D%20tostring%28properties.resourceType%29%20%20%29%20on%20%24left.storageAccountId%20%3D%3D%20%24right.storageAccountId%20%20%7C%20project-away%20storageAccountId%2C%20storageAccountId1%20%20%7C%20extend%20policyAssignmentId%20%3D%20tostring%28policyStatesProperties.policyAssignmentId%29%2C%20%20%20%20policyAssignmentName%20%3D%20tostring%28policyStatesProperties.policyAssignmentName%29%2C%20%20%20%20policyDefinitionId%20%3D%20tostring%28policyStatesProperties.policyDefinitionId%29%2C%20%20%20%20policyDefinitionName%20%3D%20tostring%28policyStatesProperties.policyDefinitionName%29%2C%20%20%20%20policySetDefinitionName%20%3D%20tostring%28policyStatesProperties.policySetDefinitionName%29%2C%20%20%20%20evaluationTime%20%3D%20tostring%28policyStatesProperties.timestamp%29%2C%20%20%20%20complianceState%20%3D%20tostring%28policyStatesProperties.complianceState%29" target="_blank">portal.Azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/resources%20%20%7C%20where%20type%20%3D~%20%22Microsoft.Storage%2FstorageAccounts%22%20%20%7C%20where%20tags%5B%27clusterName%27%5D%20%3D~%20%27tagname%27%20%20%7C%20extend%20storageAccountId%20%3D%20tolower%28id%29%20%20%7C%20join%20kind%3Dleftouter%28%20%20%20%20%20%20policyresources%20%20%20%20%20%20%7C%20where%20%5B%27type%27%5D%20%3D~%20%22Microsoft.PolicyInsights%2FpolicyStates%22%20%20%20%20%20%20%7C%20project%20storageAccountId%20%3D%20tolower%28properties.resourceId%29%2C%20policyStatesProperties%20%3D%20properties%2C%20resourceType%20%3D%20tostring%28properties.resourceType%29%20%20%29%20on%20%24left.storageAccountId%20%3D%3D%20%24right.storageAccountId%20%20%7C%20project-away%20storageAccountId%2C%20storageAccountId1%20%20%7C%20extend%20policyAssignmentId%20%3D%20tostring%28policyStatesProperties.policyAssignmentId%29%2C%20%20%20%20policyAssignmentName%20%3D%20tostring%28policyStatesProperties.policyAssignmentName%29%2C%20%20%20%20policyDefinitionId%20%3D%20tostring%28policyStatesProperties.policyDefinitionId%29%2C%20%20%20%20policyDefinitionName%20%3D%20tostring%28policyStatesProperties.policyDefinitionName%29%2C%20%20%20%20policySetDefinitionName%20%3D%20tostring%28policyStatesProperties.policySetDefinitionName%29%2C%20%20%20%20evaluationTime%20%3D%20tostring%28policyStatesProperties.timestamp%29%2C%20%20%20%20complianceState%20%3D%20tostring%28policyStatesProperties.complianceState%29" target="_blank">portal.Azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/resources%20%20%7C%20where%20type%20%3D~%20%22Microsoft.Storage%2FstorageAccounts%22%20%20%7C%20where%20tags%5B%27clusterName%27%5D%20%3D~%20%27tagname%27%20%20%7C%20extend%20storageAccountId%20%3D%20tolower%28id%29%20%20%7C%20join%20kind%3Dleftouter%28%20%20%20%20%20%20policyresources%20%20%20%20%20%20%7C%20where%20%5B%27type%27%5D%20%3D~%20%22Microsoft.PolicyInsights%2FpolicyStates%22%20%20%20%20%20%20%7C%20project%20storageAccountId%20%3D%20tolower%28properties.resourceId%29%2C%20policyStatesProperties%20%3D%20properties%2C%20resourceType%20%3D%20tostring%28properties.resourceType%29%20%20%29%20on%20%24left.storageAccountId%20%3D%3D%20%24right.storageAccountId%20%20%7C%20project-away%20storageAccountId%2C%20storageAccountId1%20%20%7C%20extend%20policyAssignmentId%20%3D%20tostring%28policyStatesProperties.policyAssignmentId%29%2C%20%20%20%20policyAssignmentName%20%3D%20tostring%28policyStatesProperties.policyAssignmentName%29%2C%20%20%20%20policyDefinitionId%20%3D%20tostring%28policyStatesProperties.policyDefinitionId%29%2C%20%20%20%20policyDefinitionName%20%3D%20tostring%28policyStatesProperties.policyDefinitionName%29%2C%20%20%20%20policySetDefinitionName%20%3D%20tostring%28policyStatesProperties.policySetDefinitionName%29%2C%20%20%20%20evaluationTime%20%3D%20tostring%28policyStatesProperties.timestamp%29%2C%20%20%20%20complianceState%20%3D%20tostring%28policyStatesProperties.complianceState%29" target="_blank">portal.Azure.cn</a>

---

### Compliance by policy assignment

Provides compliance state, compliance percentage, and counts of resources for each Azure Policy assignment.

```kusto
PolicyResources
| where type =~ 'Microsoft.PolicyInsights/PolicyStates'
| extend complianceState = tostring(properties.complianceState)
| extend
	resourceId = tostring(properties.resourceId),
	policyAssignmentId = tostring(properties.policyAssignmentId),
	policyAssignmentScope = tostring(properties.policyAssignmentScope),
	policyAssignmentName = tostring(properties.policyAssignmentName),
	policyDefinitionId = tostring(properties.policyDefinitionId),
	policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId),
	stateWeight = iff(complianceState == 'NonCompliant', int(300), iff(complianceState == 'Compliant', int(200), iff(complianceState == 'Conflict', int(100), iff(complianceState == 'Exempt', int(50), int(0)))))
| summarize max(stateWeight) by resourceId, policyAssignmentId, policyAssignmentScope, policyAssignmentName
| summarize counts = count() by policyAssignmentId, policyAssignmentScope, max_stateWeight, policyAssignmentName
| summarize overallStateWeight = max(max_stateWeight),
nonCompliantCount = sumif(counts, max_stateWeight == 300),
compliantCount = sumif(counts, max_stateWeight == 200),
conflictCount = sumif(counts, max_stateWeight == 100),
exemptCount = sumif(counts, max_stateWeight == 50) by policyAssignmentId, policyAssignmentScope, policyAssignmentName
| extend totalResources = todouble(nonCompliantCount + compliantCount + conflictCount + exemptCount)
| extend compliancePercentage = iff(totalResources == 0, todouble(100), 100 * todouble(compliantCount + exemptCount) / totalResources)
| project policyAssignmentName, scope = policyAssignmentScope,
complianceState = iff(overallStateWeight == 300, 'noncompliant', iff(overallStateWeight == 200, 'compliant', iff(overallStateWeight == 100, 'conflict', iff(overallStateWeight == 50, 'exempt', 'notstarted')))),
compliancePercentage,
compliantCount,
nonCompliantCount,
conflictCount,
exemptCount
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "PolicyResources | where type =~ 'Microsoft.PolicyInsights/PolicyStates' | extend complianceState = tostring(properties.complianceState) | extend resourceId = tostring(properties.resourceId), policyAssignmentId = tostring(properties.policyAssignmentId), policyAssignmentScope = tostring(properties.policyAssignmentScope), policyAssignmentName = tostring(properties.policyAssignmentName), policyDefinitionId = tostring(properties.policyDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), stateWeight = iff(complianceState == 'NonCompliant', int(300), iff(complianceState == 'Compliant', int(200), iff(complianceState == 'Conflict', int(100), iff(complianceState == 'Exempt', int(50), int(0))))) | summarize max(stateWeight) by resourceId, policyAssignmentId, policyAssignmentScope, policyAssignmentName | summarize counts = count() by policyAssignmentId, policyAssignmentScope, max_stateWeight, policyAssignmentName | summarize overallStateWeight = max(max_stateWeight), nonCompliantCount = sumif(counts, max_stateWeight == 300), compliantCount = sumif(counts, max_stateWeight == 200), conflictCount = sumif(counts, max_stateWeight == 100), exemptCount = sumif(counts, max_stateWeight == 50) by policyAssignmentId, policyAssignmentScope, policyAssignmentName | extend totalResources = todouble(nonCompliantCount + compliantCount + conflictCount + exemptCount) | extend compliancePercentage = iff(totalResources == 0, todouble(100), 100 * todouble(compliantCount + exemptCount) / totalResources) | project policyAssignmentName, scope = policyAssignmentScope, complianceState = iff(overallStateWeight == 300, 'noncompliant', iff(overallStateWeight == 200, 'compliant', iff(overallStateWeight == 100, 'conflict', iff(overallStateWeight == 50, 'exempt', 'notstarted')))), compliancePercentage, compliantCount, nonCompliantCount, conflictCount, exemptCount"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "PolicyResources | where type =~ 'Microsoft.PolicyInsights/PolicyStates' | extend complianceState = tostring(properties.complianceState) | extend resourceId = tostring(properties.resourceId), policyAssignmentId = tostring(properties.policyAssignmentId), policyAssignmentScope = tostring(properties.policyAssignmentScope), policyAssignmentName = tostring(properties.policyAssignmentName), policyDefinitionId = tostring(properties.policyDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), stateWeight = iff(complianceState == 'NonCompliant', int(300), iff(complianceState == 'Compliant', int(200), iff(complianceState == 'Conflict', int(100), iff(complianceState == 'Exempt', int(50), int(0))))) | summarize max(stateWeight) by resourceId, policyAssignmentId, policyAssignmentScope, policyAssignmentName | summarize counts = count() by policyAssignmentId, policyAssignmentScope, max_stateWeight, policyAssignmentName | summarize overallStateWeight = max(max_stateWeight), nonCompliantCount = sumif(counts, max_stateWeight == 300), compliantCount = sumif(counts, max_stateWeight == 200), conflictCount = sumif(counts, max_stateWeight == 100), exemptCount = sumif(counts, max_stateWeight == 50) by policyAssignmentId, policyAssignmentScope, policyAssignmentName | extend totalResources = todouble(nonCompliantCount + compliantCount + conflictCount + exemptCount) | extend compliancePercentage = iff(totalResources == 0, todouble(100), 100 * todouble(compliantCount + exemptCount) / totalResources) | project policyAssignmentName, scope = policyAssignmentScope, complianceState = iff(overallStateWeight == 300, 'noncompliant', iff(overallStateWeight == 200, 'compliant', iff(overallStateWeight == 100, 'conflict', iff(overallStateWeight == 50, 'exempt', 'notstarted')))), compliancePercentage, compliantCount, nonCompliantCount, conflictCount, exemptCount"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%20where%20type%20%3d%7e%20%27Microsoft.PolicyInsights%2fPolicyStates%27%0a%7c%20extend%20complianceState%20%3d%20tostring(properties.complianceState)%0a%7c%20extend%0a%09resourceId%20%3d%20tostring(properties.resourceId)%2c%0a%09policyAssignmentId%20%3d%20tostring(properties.policyAssignmentId)%2c%0a%09policyAssignmentScope%20%3d%20tostring(properties.policyAssignmentScope)%2c%0a%09policyAssignmentName%20%3d%20tostring(properties.policyAssignmentName)%2c%0a%09policyDefinitionId%20%3d%20tostring(properties.policyDefinitionId)%2c%0a%09policyDefinitionReferenceId%20%3d%20tostring(properties.policyDefinitionReferenceId)%2c%0a%09stateWeight%20%3d%20iff(complianceState%20%3d%3d%20%27NonCompliant%27%2c%20int(300)%2c%20iff(complianceState%20%3d%3d%20%27Compliant%27%2c%20int(200)%2c%20iff(complianceState%20%3d%3d%20%27Conflict%27%2c%20int(100)%2c%20iff(complianceState%20%3d%3d%20%27Exempt%27%2c%20int(50)%2c%20int(0)))))%0a%7c%20summarize%20max(stateWeight)%20by%20resourceId%2c%20policyAssignmentId%2c%20policyAssignmentScope%2c%20policyAssignmentName%0a%7c%20summarize%20counts%20%3d%20count()%20by%20policyAssignmentId%2c%20policyAssignmentScope%2c%20max_stateWeight%2c%20policyAssignmentName%0a%7c%20summarize%20overallStateWeight%20%3d%20max(max_stateWeight)%2c%0anonCompliantCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20300)%2c%0acompliantCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20200)%2c%0aconflictCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20100)%2c%0aexemptCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%2050)%20by%20policyAssignmentId%2c%20policyAssignmentScope%2c%20policyAssignmentName%0a%7c%20extend%20totalResources%20%3d%20todouble(nonCompliantCount%20%2b%20compliantCount%20%2b%20conflictCount%20%2b%20exemptCount)%0a%7c%20extend%20compliancePercentage%20%3d%20iff(totalResources%20%3d%3d%200%2c%20todouble(100)%2c%20100%20*%20todouble(compliantCount%20%2b%20exemptCount)%20%2f%20totalResources)%0a%7c%20project%20policyAssignmentName%2c%20scope%20%3d%20policyAssignmentScope%2c%0acomplianceState%20%3d%20iff(overallStateWeight%20%3d%3d%20300%2c%20%27noncompliant%27%2c%20iff(overallStateWeight%20%3d%3d%20200%2c%20%27compliant%27%2c%20iff(overallStateWeight%20%3d%3d%20100%2c%20%27conflict%27%2c%20iff(overallStateWeight%20%3d%3d%2050%2c%20%27exempt%27%2c%20%27notstarted%27))))%2c%0acompliancePercentage%2c%0acompliantCount%2c%0anonCompliantCount%2c%0aconflictCount%2c%0aexemptCount" target="_blank">portal.azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%20where%20type%20%3d%7e%20%27Microsoft.PolicyInsights%2fPolicyStates%27%0a%7c%20extend%20complianceState%20%3d%20tostring(properties.complianceState)%0a%7c%20extend%0a%09resourceId%20%3d%20tostring(properties.resourceId)%2c%0a%09policyAssignmentId%20%3d%20tostring(properties.policyAssignmentId)%2c%0a%09policyAssignmentScope%20%3d%20tostring(properties.policyAssignmentScope)%2c%0a%09policyAssignmentName%20%3d%20tostring(properties.policyAssignmentName)%2c%0a%09policyDefinitionId%20%3d%20tostring(properties.policyDefinitionId)%2c%0a%09policyDefinitionReferenceId%20%3d%20tostring(properties.policyDefinitionReferenceId)%2c%0a%09stateWeight%20%3d%20iff(complianceState%20%3d%3d%20%27NonCompliant%27%2c%20int(300)%2c%20iff(complianceState%20%3d%3d%20%27Compliant%27%2c%20int(200)%2c%20iff(complianceState%20%3d%3d%20%27Conflict%27%2c%20int(100)%2c%20iff(complianceState%20%3d%3d%20%27Exempt%27%2c%20int(50)%2c%20int(0)))))%0a%7c%20summarize%20max(stateWeight)%20by%20resourceId%2c%20policyAssignmentId%2c%20policyAssignmentScope%2c%20policyAssignmentName%0a%7c%20summarize%20counts%20%3d%20count()%20by%20policyAssignmentId%2c%20policyAssignmentScope%2c%20max_stateWeight%2c%20policyAssignmentName%0a%7c%20summarize%20overallStateWeight%20%3d%20max(max_stateWeight)%2c%0anonCompliantCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20300)%2c%0acompliantCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20200)%2c%0aconflictCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20100)%2c%0aexemptCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%2050)%20by%20policyAssignmentId%2c%20policyAssignmentScope%2c%20policyAssignmentName%0a%7c%20extend%20totalResources%20%3d%20todouble(nonCompliantCount%20%2b%20compliantCount%20%2b%20conflictCount%20%2b%20exemptCount)%0a%7c%20extend%20compliancePercentage%20%3d%20iff(totalResources%20%3d%3d%200%2c%20todouble(100)%2c%20100%20*%20todouble(compliantCount%20%2b%20exemptCount)%20%2f%20totalResources)%0a%7c%20project%20policyAssignmentName%2c%20scope%20%3d%20policyAssignmentScope%2c%0acomplianceState%20%3d%20iff(overallStateWeight%20%3d%3d%20300%2c%20%27noncompliant%27%2c%20iff(overallStateWeight%20%3d%3d%20200%2c%20%27compliant%27%2c%20iff(overallStateWeight%20%3d%3d%20100%2c%20%27conflict%27%2c%20iff(overallStateWeight%20%3d%3d%2050%2c%20%27exempt%27%2c%20%27notstarted%27))))%2c%0acompliancePercentage%2c%0acompliantCount%2c%0anonCompliantCount%2c%0aconflictCount%2c%0aexemptCount" target="_blank">portal.azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%20where%20type%20%3d%7e%20%27Microsoft.PolicyInsights%2fPolicyStates%27%0a%7c%20extend%20complianceState%20%3d%20tostring(properties.complianceState)%0a%7c%20extend%0a%09resourceId%20%3d%20tostring(properties.resourceId)%2c%0a%09policyAssignmentId%20%3d%20tostring(properties.policyAssignmentId)%2c%0a%09policyAssignmentScope%20%3d%20tostring(properties.policyAssignmentScope)%2c%0a%09policyAssignmentName%20%3d%20tostring(properties.policyAssignmentName)%2c%0a%09policyDefinitionId%20%3d%20tostring(properties.policyDefinitionId)%2c%0a%09policyDefinitionReferenceId%20%3d%20tostring(properties.policyDefinitionReferenceId)%2c%0a%09stateWeight%20%3d%20iff(complianceState%20%3d%3d%20%27NonCompliant%27%2c%20int(300)%2c%20iff(complianceState%20%3d%3d%20%27Compliant%27%2c%20int(200)%2c%20iff(complianceState%20%3d%3d%20%27Conflict%27%2c%20int(100)%2c%20iff(complianceState%20%3d%3d%20%27Exempt%27%2c%20int(50)%2c%20int(0)))))%0a%7c%20summarize%20max(stateWeight)%20by%20resourceId%2c%20policyAssignmentId%2c%20policyAssignmentScope%2c%20policyAssignmentName%0a%7c%20summarize%20counts%20%3d%20count()%20by%20policyAssignmentId%2c%20policyAssignmentScope%2c%20max_stateWeight%2c%20policyAssignmentName%0a%7c%20summarize%20overallStateWeight%20%3d%20max(max_stateWeight)%2c%0anonCompliantCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20300)%2c%0acompliantCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20200)%2c%0aconflictCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20100)%2c%0aexemptCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%2050)%20by%20policyAssignmentId%2c%20policyAssignmentScope%2c%20policyAssignmentName%0a%7c%20extend%20totalResources%20%3d%20todouble(nonCompliantCount%20%2b%20compliantCount%20%2b%20conflictCount%20%2b%20exemptCount)%0a%7c%20extend%20compliancePercentage%20%3d%20iff(totalResources%20%3d%3d%200%2c%20todouble(100)%2c%20100%20*%20todouble(compliantCount%20%2b%20exemptCount)%20%2f%20totalResources)%0a%7c%20project%20policyAssignmentName%2c%20scope%20%3d%20policyAssignmentScope%2c%0acomplianceState%20%3d%20iff(overallStateWeight%20%3d%3d%20300%2c%20%27noncompliant%27%2c%20iff(overallStateWeight%20%3d%3d%20200%2c%20%27compliant%27%2c%20iff(overallStateWeight%20%3d%3d%20100%2c%20%27conflict%27%2c%20iff(overallStateWeight%20%3d%3d%2050%2c%20%27exempt%27%2c%20%27notstarted%27))))%2c%0acompliancePercentage%2c%0acompliantCount%2c%0anonCompliantCount%2c%0aconflictCount%2c%0aexemptCount" target="_blank">portal.azure.cn</a>

---

### Compliance by resource type

Provides compliance state, compliance percentage, and counts of resources for each resource type.

```kusto
PolicyResources
| where type =~ 'Microsoft.PolicyInsights/PolicyStates'
| extend complianceState = tostring(properties.complianceState)
| extend
	resourceId = tostring(properties.resourceId),
	resourceType = tolower(tostring(properties.resourceType)),
	policyAssignmentId = tostring(properties.policyAssignmentId),
	policyDefinitionId = tostring(properties.policyDefinitionId),
	policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId),
	stateWeight = iff(complianceState == 'NonCompliant', int(300), iff(complianceState == 'Compliant', int(200), iff(complianceState == 'Conflict', int(100), iff(complianceState == 'Exempt', int(50), int(0)))))
| summarize max(stateWeight) by resourceId, resourceType
| summarize counts = count() by resourceType, max_stateWeight
| summarize overallStateWeight = max(max_stateWeight),
nonCompliantCount = sumif(counts, max_stateWeight == 300),
compliantCount = sumif(counts, max_stateWeight == 200),
conflictCount = sumif(counts, max_stateWeight == 100),
exemptCount = sumif(counts, max_stateWeight == 50) by resourceType
| extend totalResources = todouble(nonCompliantCount + compliantCount + conflictCount + exemptCount)
| extend compliancePercentage = iff(totalResources == 0, todouble(100), 100 * todouble(compliantCount + exemptCount) / totalResources)
| project resourceType,
overAllComplianceState = iff(overallStateWeight == 300, 'noncompliant', iff(overallStateWeight == 200, 'compliant', iff(overallStateWeight == 100, 'conflict', iff(overallStateWeight == 50, 'exempt', 'notstarted')))),
compliancePercentage,
compliantCount,
nonCompliantCount,
conflictCount,
exemptCount
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "PolicyResources | where type =~ 'Microsoft.PolicyInsights/PolicyStates' | extend complianceState = tostring(properties.complianceState) | extend resourceId = tostring(properties.resourceId), resourceType = tolower(tostring(properties.resourceType)), policyAssignmentId = tostring(properties.policyAssignmentId), policyDefinitionId = tostring(properties.policyDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), stateWeight = iff(complianceState == 'NonCompliant', int(300), iff(complianceState == 'Compliant', int(200), iff(complianceState == 'Conflict', int(100), iff(complianceState == 'Exempt', int(50), int(0))))) | summarize max(stateWeight) by resourceId, resourceType | summarize counts = count() by resourceType, max_stateWeight | summarize overallStateWeight = max(max_stateWeight), nonCompliantCount = sumif(counts, max_stateWeight == 300), compliantCount = sumif(counts, max_stateWeight == 200), conflictCount = sumif(counts, max_stateWeight == 100), exemptCount = sumif(counts, max_stateWeight == 50) by resourceType | extend totalResources = todouble(nonCompliantCount + compliantCount + conflictCount + exemptCount) | extend compliancePercentage = iff(totalResources == 0, todouble(100), 100 * todouble(compliantCount + exemptCount) / totalResources) | project resourceType, overAllComplianceState = iff(overallStateWeight == 300, 'noncompliant', iff(overallStateWeight == 200, 'compliant', iff(overallStateWeight == 100, 'conflict', iff(overallStateWeight == 50, 'exempt', 'notstarted')))), compliancePercentage, compliantCount, nonCompliantCount, conflictCount, exemptCount"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "PolicyResources | where type =~ 'Microsoft.PolicyInsights/PolicyStates' | extend complianceState = tostring(properties.complianceState) | extend resourceId = tostring(properties.resourceId), resourceType = tolower(tostring(properties.resourceType)), policyAssignmentId = tostring(properties.policyAssignmentId), policyDefinitionId = tostring(properties.policyDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), stateWeight = iff(complianceState == 'NonCompliant', int(300), iff(complianceState == 'Compliant', int(200), iff(complianceState == 'Conflict', int(100), iff(complianceState == 'Exempt', int(50), int(0))))) | summarize max(stateWeight) by resourceId, resourceType | summarize counts = count() by resourceType, max_stateWeight | summarize overallStateWeight = max(max_stateWeight), nonCompliantCount = sumif(counts, max_stateWeight == 300), compliantCount = sumif(counts, max_stateWeight == 200), conflictCount = sumif(counts, max_stateWeight == 100), exemptCount = sumif(counts, max_stateWeight == 50) by resourceType | extend totalResources = todouble(nonCompliantCount + compliantCount + conflictCount + exemptCount) | extend compliancePercentage = iff(totalResources == 0, todouble(100), 100 * todouble(compliantCount + exemptCount) / totalResources) | project resourceType, overAllComplianceState = iff(overallStateWeight == 300, 'noncompliant', iff(overallStateWeight == 200, 'compliant', iff(overallStateWeight == 100, 'conflict', iff(overallStateWeight == 50, 'exempt', 'notstarted')))), compliancePercentage, compliantCount, nonCompliantCount, conflictCount, exemptCount"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%20where%20type%20%3d%7e%20%27Microsoft.PolicyInsights%2fPolicyStates%27%0a%7c%20extend%20complianceState%20%3d%20tostring(properties.complianceState)%0a%7c%20extend%0a%09resourceId%20%3d%20tostring(properties.resourceId)%2c%0a%09resourceType%20%3d%20tolower(tostring(properties.resourceType))%2c%0a%09policyAssignmentId%20%3d%20tostring(properties.policyAssignmentId)%2c%0a%09policyDefinitionId%20%3d%20tostring(properties.policyDefinitionId)%2c%0a%09policyDefinitionReferenceId%20%3d%20tostring(properties.policyDefinitionReferenceId)%2c%0a%09stateWeight%20%3d%20iff(complianceState%20%3d%3d%20%27NonCompliant%27%2c%20int(300)%2c%20iff(complianceState%20%3d%3d%20%27Compliant%27%2c%20int(200)%2c%20iff(complianceState%20%3d%3d%20%27Conflict%27%2c%20int(100)%2c%20iff(complianceState%20%3d%3d%20%27Exempt%27%2c%20int(50)%2c%20int(0)))))%0a%7c%20summarize%20max(stateWeight)%20by%20resourceId%2c%20resourceType%0a%7c%20summarize%20counts%20%3d%20count()%20by%20resourceType%2c%20max_stateWeight%0a%7c%20summarize%20overallStateWeight%20%3d%20max(max_stateWeight)%2c%0anonCompliantCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20300)%2c%0acompliantCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20200)%2c%0aconflictCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20100)%2c%0aexemptCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%2050)%20by%20resourceType%0a%7c%20extend%20totalResources%20%3d%20todouble(nonCompliantCount%20%2b%20compliantCount%20%2b%20conflictCount%20%2b%20exemptCount)%0a%7c%20extend%20compliancePercentage%20%3d%20iff(totalResources%20%3d%3d%200%2c%20todouble(100)%2c%20100%20*%20todouble(compliantCount%20%2b%20exemptCount)%20%2f%20totalResources)%0a%7c%20project%20resourceType%2c%0aoverAllComplianceState%20%3d%20iff(overallStateWeight%20%3d%3d%20300%2c%20%27noncompliant%27%2c%20iff(overallStateWeight%20%3d%3d%20200%2c%20%27compliant%27%2c%20iff(overallStateWeight%20%3d%3d%20100%2c%20%27conflict%27%2c%20iff(overallStateWeight%20%3d%3d%2050%2c%20%27exempt%27%2c%20%27notstarted%27))))%2c%0acompliancePercentage%2c%0acompliantCount%2c%0anonCompliantCount%2c%0aconflictCount%2c%0aexemptCount" target="_blank">portal.azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%20where%20type%20%3d%7e%20%27Microsoft.PolicyInsights%2fPolicyStates%27%0a%7c%20extend%20complianceState%20%3d%20tostring(properties.complianceState)%0a%7c%20extend%0a%09resourceId%20%3d%20tostring(properties.resourceId)%2c%0a%09resourceType%20%3d%20tolower(tostring(properties.resourceType))%2c%0a%09policyAssignmentId%20%3d%20tostring(properties.policyAssignmentId)%2c%0a%09policyDefinitionId%20%3d%20tostring(properties.policyDefinitionId)%2c%0a%09policyDefinitionReferenceId%20%3d%20tostring(properties.policyDefinitionReferenceId)%2c%0a%09stateWeight%20%3d%20iff(complianceState%20%3d%3d%20%27NonCompliant%27%2c%20int(300)%2c%20iff(complianceState%20%3d%3d%20%27Compliant%27%2c%20int(200)%2c%20iff(complianceState%20%3d%3d%20%27Conflict%27%2c%20int(100)%2c%20iff(complianceState%20%3d%3d%20%27Exempt%27%2c%20int(50)%2c%20int(0)))))%0a%7c%20summarize%20max(stateWeight)%20by%20resourceId%2c%20resourceType%0a%7c%20summarize%20counts%20%3d%20count()%20by%20resourceType%2c%20max_stateWeight%0a%7c%20summarize%20overallStateWeight%20%3d%20max(max_stateWeight)%2c%0anonCompliantCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20300)%2c%0acompliantCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20200)%2c%0aconflictCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20100)%2c%0aexemptCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%2050)%20by%20resourceType%0a%7c%20extend%20totalResources%20%3d%20todouble(nonCompliantCount%20%2b%20compliantCount%20%2b%20conflictCount%20%2b%20exemptCount)%0a%7c%20extend%20compliancePercentage%20%3d%20iff(totalResources%20%3d%3d%200%2c%20todouble(100)%2c%20100%20*%20todouble(compliantCount%20%2b%20exemptCount)%20%2f%20totalResources)%0a%7c%20project%20resourceType%2c%0aoverAllComplianceState%20%3d%20iff(overallStateWeight%20%3d%3d%20300%2c%20%27noncompliant%27%2c%20iff(overallStateWeight%20%3d%3d%20200%2c%20%27compliant%27%2c%20iff(overallStateWeight%20%3d%3d%20100%2c%20%27conflict%27%2c%20iff(overallStateWeight%20%3d%3d%2050%2c%20%27exempt%27%2c%20%27notstarted%27))))%2c%0acompliancePercentage%2c%0acompliantCount%2c%0anonCompliantCount%2c%0aconflictCount%2c%0aexemptCount" target="_blank">portal.azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%20where%20type%20%3d%7e%20%27Microsoft.PolicyInsights%2fPolicyStates%27%0a%7c%20extend%20complianceState%20%3d%20tostring(properties.complianceState)%0a%7c%20extend%0a%09resourceId%20%3d%20tostring(properties.resourceId)%2c%0a%09resourceType%20%3d%20tolower(tostring(properties.resourceType))%2c%0a%09policyAssignmentId%20%3d%20tostring(properties.policyAssignmentId)%2c%0a%09policyDefinitionId%20%3d%20tostring(properties.policyDefinitionId)%2c%0a%09policyDefinitionReferenceId%20%3d%20tostring(properties.policyDefinitionReferenceId)%2c%0a%09stateWeight%20%3d%20iff(complianceState%20%3d%3d%20%27NonCompliant%27%2c%20int(300)%2c%20iff(complianceState%20%3d%3d%20%27Compliant%27%2c%20int(200)%2c%20iff(complianceState%20%3d%3d%20%27Conflict%27%2c%20int(100)%2c%20iff(complianceState%20%3d%3d%20%27Exempt%27%2c%20int(50)%2c%20int(0)))))%0a%7c%20summarize%20max(stateWeight)%20by%20resourceId%2c%20resourceType%0a%7c%20summarize%20counts%20%3d%20count()%20by%20resourceType%2c%20max_stateWeight%0a%7c%20summarize%20overallStateWeight%20%3d%20max(max_stateWeight)%2c%0anonCompliantCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20300)%2c%0acompliantCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20200)%2c%0aconflictCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%20100)%2c%0aexemptCount%20%3d%20sumif(counts%2c%20max_stateWeight%20%3d%3d%2050)%20by%20resourceType%0a%7c%20extend%20totalResources%20%3d%20todouble(nonCompliantCount%20%2b%20compliantCount%20%2b%20conflictCount%20%2b%20exemptCount)%0a%7c%20extend%20compliancePercentage%20%3d%20iff(totalResources%20%3d%3d%200%2c%20todouble(100)%2c%20100%20*%20todouble(compliantCount%20%2b%20exemptCount)%20%2f%20totalResources)%0a%7c%20project%20resourceType%2c%0aoverAllComplianceState%20%3d%20iff(overallStateWeight%20%3d%3d%20300%2c%20%27noncompliant%27%2c%20iff(overallStateWeight%20%3d%3d%20200%2c%20%27compliant%27%2c%20iff(overallStateWeight%20%3d%3d%20100%2c%20%27conflict%27%2c%20iff(overallStateWeight%20%3d%3d%2050%2c%20%27exempt%27%2c%20%27notstarted%27))))%2c%0acompliancePercentage%2c%0acompliantCount%2c%0anonCompliantCount%2c%0aconflictCount%2c%0aexemptCount" target="_blank">portal.azure.cn</a>

---

### List all non-compliant resources

Provides a list of all resources types that are in a `NonCompliant` state.

```kusto
PolicyResources
| where type == 'microsoft.policyinsights/policystates'
| where properties.complianceState == 'NonCompliant'
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "PolicyResources | where type == 'microsoft.policyinsights/policystates' | where properties.complianceState == 'NonCompliant'"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "PolicyResources | where type == 'microsoft.policyinsights/policystates' | where properties.complianceState == 'NonCompliant'"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%e2%80%afwhere%e2%80%aftype%e2%80%af%3d%3d%e2%80%af%27microsoft.policyinsights%2fpolicystates%27%0a%7c%e2%80%afwhere%e2%80%afproperties.complianceState%e2%80%af%3d%3d%e2%80%af%27NonCompliant%27" target="_blank">portal.azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%e2%80%afwhere%e2%80%aftype%e2%80%af%3d%3d%e2%80%af%27microsoft.policyinsights%2fpolicystates%27%0a%7c%e2%80%afwhere%e2%80%afproperties.complianceState%e2%80%af%3d%3d%e2%80%af%27NonCompliant%27" target="_blank">portal.azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%e2%80%afwhere%e2%80%aftype%e2%80%af%3d%3d%e2%80%af%27microsoft.policyinsights%2fpolicystates%27%0a%7c%e2%80%afwhere%e2%80%afproperties.complianceState%e2%80%af%3d%3d%e2%80%af%27NonCompliant%27" target="_blank">portal.azure.cn</a>

---

### Summarize resource compliance by state

Details the number of resources in each compliance state.

```kusto
PolicyResources
| where type == 'microsoft.policyinsights/policystates'
| extend complianceState = tostring(properties.complianceState)
| summarize count() by complianceState
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "PolicyResources | where type == 'microsoft.policyinsights/policystates' | extend complianceState = tostring(properties.complianceState) | summarize count() by complianceState"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "PolicyResources | where type == 'microsoft.policyinsights/policystates' | extend complianceState = tostring(properties.complianceState) | summarize count() by complianceState"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%e2%80%afwhere%e2%80%aftype%e2%80%af%3d%3d%e2%80%af%27microsoft.policyinsights%2fpolicystates%27%0a%7c%e2%80%afextend%e2%80%afcomplianceState%e2%80%af%3d%e2%80%aftostring(properties.complianceState)%0a%7c%e2%80%afsummarize%e2%80%afcount()%e2%80%afby%e2%80%afcomplianceState" target="_blank">portal.azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%e2%80%afwhere%e2%80%aftype%e2%80%af%3d%3d%e2%80%af%27microsoft.policyinsights%2fpolicystates%27%0a%7c%e2%80%afextend%e2%80%afcomplianceState%e2%80%af%3d%e2%80%aftostring(properties.complianceState)%0a%7c%e2%80%afsummarize%e2%80%afcount()%e2%80%afby%e2%80%afcomplianceState" target="_blank">portal.azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%e2%80%afwhere%e2%80%aftype%e2%80%af%3d%3d%e2%80%af%27microsoft.policyinsights%2fpolicystates%27%0a%7c%e2%80%afextend%e2%80%afcomplianceState%e2%80%af%3d%e2%80%aftostring(properties.complianceState)%0a%7c%e2%80%afsummarize%e2%80%afcount()%e2%80%afby%e2%80%afcomplianceState" target="_blank">portal.azure.cn</a>

---

### Summarize resource compliance by state per location

Details the number of resources in each compliance state per location.

```kusto
PolicyResources
| where type == 'microsoft.policyinsights/policystates'
| extend complianceState = tostring(properties.complianceState)
| extend resourceLocation = tostring(properties.resourceLocation)
| summarize count() by resourceLocation, complianceState
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "PolicyResources | where type == 'microsoft.policyinsights/policystates' | extend complianceState = tostring(properties.complianceState) | extend resourceLocation = tostring(properties.resourceLocation) | summarize count() by resourceLocation, complianceState"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "PolicyResources | where type == 'microsoft.policyinsights/policystates' | extend complianceState = tostring(properties.complianceState) | extend resourceLocation = tostring(properties.resourceLocation) | summarize count() by resourceLocation, complianceState"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%e2%80%afwhere%e2%80%aftype%e2%80%af%3d%3d%e2%80%af%27microsoft.policyinsights%2fpolicystates%27%0a%7c%e2%80%afextend%e2%80%afcomplianceState%e2%80%af%3d%e2%80%aftostring(properties.complianceState)%0a%7c%e2%80%afextend%e2%80%afresourceLocation%e2%80%af%3d%e2%80%aftostring(properties.resourceLocation)%0a%7c%e2%80%afsummarize%e2%80%afcount()%e2%80%afby%e2%80%afresourceLocation%2c%e2%80%afcomplianceState" target="_blank">portal.azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%e2%80%afwhere%e2%80%aftype%e2%80%af%3d%3d%e2%80%af%27microsoft.policyinsights%2fpolicystates%27%0a%7c%e2%80%afextend%e2%80%afcomplianceState%e2%80%af%3d%e2%80%aftostring(properties.complianceState)%0a%7c%e2%80%afextend%e2%80%afresourceLocation%e2%80%af%3d%e2%80%aftostring(properties.resourceLocation)%0a%7c%e2%80%afsummarize%e2%80%afcount()%e2%80%afby%e2%80%afresourceLocation%2c%e2%80%afcomplianceState" target="_blank">portal.azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources%0a%7c%e2%80%afwhere%e2%80%aftype%e2%80%af%3d%3d%e2%80%af%27microsoft.policyinsights%2fpolicystates%27%0a%7c%e2%80%afextend%e2%80%afcomplianceState%e2%80%af%3d%e2%80%aftostring(properties.complianceState)%0a%7c%e2%80%afextend%e2%80%afresourceLocation%e2%80%af%3d%e2%80%aftostring(properties.resourceLocation)%0a%7c%e2%80%afsummarize%e2%80%afcount()%e2%80%afby%e2%80%afresourceLocation%2c%e2%80%afcomplianceState" target="_blank">portal.azure.cn</a>

---

### Policy assignments and information about each of its respective definitions

The below query gets policy assignments in your environment with the respective assignment name, definition associated, category of definition (if applicable), as well as whether the definition type is an initiative or a single policy.

```kusto
policyResources
| where type =~'Microsoft.Authorization/PolicyAssignments'
| project policyAssignmentId = tolower(tostring(id)), policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId)
| join kind=leftouter(policyResources
| where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions'
| project definitionId = tolower(id), category = tostring(properties.metadata.category), definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy')
) on $left.policyAssignmentDefinitionId == $right.definitionId
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "policyResources | where type =~'Microsoft.Authorization/PolicyAssignments' | project policyAssignmentId = tolower(tostring(id)), policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId) | join kind=leftouter(policyResources | where type =~'Microsoft.Authorization PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions' | project definitionId = tolower(id), category = tostring(properties.metadatacategory), definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy')) on $left.policyAssignmentDefinitionId == $right.definitionId"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "policyResources | where type =~'Microsoft.Authorization/PolicyAssignments' | project policyAssignmentId = tolower(tostring(id)), policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId) | join kind=leftouter(policyResources | where type =~'Microsoft.Authorization PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions' | project definitionId = tolower(id), category = tostring(properties.metadatacategory), definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy')) on $left.policyAssignmentDefinitionId == $right.definitionId"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%0A%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%0A%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%0A%7C%20join%20kind%3Dleftouter%28policyResources%0A%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%0A%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%0A%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId" target="_blank">portal.Azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%0A%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%0A%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%0A%7C%20join%20kind%3Dleftouter%28policyResources%0A%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%0A%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%0A%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId" target="_blank">portal.Azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%0A%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%0A%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%0A%7C%20join%20kind%3Dleftouter%28policyResources%0A%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%0A%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%0A%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId" target="_blank">portal.Azure.cn</a>

---

### Breakdown of compliance information for each assignment at subscription, management group, an tenant root scope.

This query gets aggregated compliance and policy definition information for each of the assignments in the selected scope as well as a few additional details, including: policySetDefinition or policyDefinition details for those assignments, the number of policies/groups within the policysetDefinitions listed, number of non-compliant policies within each policySetDefinition and the resource count breakdown per compliance state for those assignments.

```kusto
policyResources
| where type =~'Microsoft.Authorization/PolicyAssignments'
| project policyAssignmentId = tolower(tostring(id)), policyAssignmentName = name, policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentScope = tostring(properties.scope), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId), policyAssignmentNotScopes = tolower(properties.notScopes)
| join kind=leftouter(
 policyResources
 | where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions'
 | project definitionId = tolower(id), type, numberOfPolicies = array_length(properties.policyDefinitions), category = tostring(properties.metadata.category), numberOfGroups= array_length(properties.policyDefinitionGroups), mode = tostring(properties.mode)
 | extend isRegulatoryInitiative = iff(category =~ 'Regulatory Compliance', true, false)
 | extend definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy')
 | extend isRPMode = iff(mode startswith 'Microsoft.', true, false)
 | project definitionId, numberOfPolicies, category, numberOfGroups, isRegulatoryInitiative, definitionType, isRPMode
) on $left.policyAssignmentDefinitionId == $right.definitionId
| join kind=leftouter(
 policyResources
 | where type =~ 'Microsoft.PolicyInsights/PolicyStates'
 | extend complianceState = tostring(properties.complianceState)
 | extend policyStateResourceId =id, resourceId = tostring(properties.resourceId), policyAssignmentId = tostring(properties.policyAssignmentId), policyDefinitionId = tostring(properties.policyDefinitionId), policySetDefinitionId = tostring(properties.policySetDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), policyDefinitionAction = tostring(properties.policyDefinitionAction), policyDefinitionGroupNames = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic([''])), stateWeight = toint(properties.stateWeight)
 | summarize max(stateWeight) by resourceId, policyAssignmentId, policySetDefinitionId
 | summarize resourceCounts = count() by policyAssignmentId, policySetDefinitionId, max_stateWeight
| extend complianceState = case(
max_stateWeight == 300, 'noncompliant',
max_stateWeight == 200, 'compliant',
max_stateWeight == 100, 'conflict',
max_stateWeight == 50, 'exempt',
max_stateWeight == 10, 'unknown',
'notapplicable')
 | extend pack = pack('complianceState', complianceState, 'resourceCounts', resourceCounts), numberOfNonCompliantResources = toint(iff(complianceState =~ 'NonCompliant', resourceCounts,0))
 | summarize numberOfNonCompliantResources = max(numberOfNonCompliantResources), details = makelist(pack) by policyAssignmentId, policySetDefinitionId
 | limit 5000
) on $left.policyAssignmentId == $right.policyAssignmentId
| sort by numberOfNonCompliantResources desc
| project-away policyAssignmentId1
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "policyResources | where type =~'Microsoft.Authorization/PolicyAssignments' | project policyAssignmentId = tolower(tostring(id)), policyAssignmentName = name, policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentScope = tostring(properties.scope), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId), policyAssignmentNotScopes = tolower(properties.notScopes) | join kind=leftouter(  policyResources  | where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions'  | project definitionId = tolower(id), type, numberOfPolicies = array_length(properties.policyDefinitions), category = tostring(properties.metadata.category), numberOfGroups= array_length(properties.policyDefinitionGroups), mode = tostring(properties.mode)  | extend isRegulatoryInitiative = iff(category =~ 'Regulatory Compliance', true, false)  | extend definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy')  | extend isRPMode = iff(mode startswith 'Microsoft.', true, false)  | project definitionId, numberOfPolicies, category, numberOfGroups, isRegulatoryInitiative, definitionType, isRPMode ) on $left.policyAssignmentDefinitionId == $right.definitionId | join kind=leftouter(  policyResources  | where type =~ 'Microsoft.PolicyInsights/PolicyStates'  | extend complianceState = tostring(properties.complianceState)  | extend policyStateResourceId =id, resourceId = tostring(properties.resourceId), policyAssignmentId = tostring(properties.policyAssignmentId), policyDefinitionId = tostring(properties.policyDefinitionId), policySetDefinitionId = tostring(properties.policySetDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), policyDefinitionAction = tostring(properties.policyDefinitionAction), policyDefinitionGroupNames = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic([''])), stateWeight = toint(properties.stateWeight)  | summarize max(stateWeight) by resourceId, policyAssignmentId, policySetDefinitionId  | summarize resourceCounts = count() by policyAssignmentId, policySetDefinitionId, max_stateWeight | extend complianceState = case( max_stateWeight == 300, 'noncompliant', max_stateWeight == 200, 'compliant', max_stateWeight == 100, 'conflict', max_stateWeight == 50, 'exempt', max_stateWeight == 10, 'unknown', 'notapplicable')  | extend pack = pack('complianceState', complianceState, 'resourceCounts', resourceCounts), numberOfNonCompliantResources = toint(iff(complianceState =~ 'NonCompliant', resourceCounts,0))  | summarize numberOfNonCompliantResources = max(numberOfNonCompliantResources), details = makelist(pack) by policyAssignmentId, policySetDefinitionId  | limit 5000 ) on $left.policyAssignmentId == $right.policyAssignmentId | sort by numberOfNonCompliantResources desc | project-away policyAssignmentId1"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "policyResources | where type =~'Microsoft.Authorization/PolicyAssignments' | project policyAssignmentId = tolower(tostring(id)), policyAssignmentName = name, policyAssignmentDisplayName = tostring(properties.displayName), policyAssignmentScope = tostring(properties.scope), policyAssignmentDefinitionId = tolower(properties.policyDefinitionId), policyAssignmentNotScopes = tolower(properties.notScopes) | join kind=leftouter(  policyResources  | where type =~'Microsoft.Authorization/PolicySetDefinitions' or type =~'Microsoft.Authorization/PolicyDefinitions'  | project definitionId = tolower(id), type, numberOfPolicies = array_length(properties.policyDefinitions), category = tostring(properties.metadata.category), numberOfGroups= array_length(properties.policyDefinitionGroups), mode = tostring(properties.mode)  | extend isRegulatoryInitiative = iff(category =~ 'Regulatory Compliance', true, false)  | extend definitionType = iff(type =~ 'Microsoft.Authorization/PolicysetDefinitions', 'initiative', 'policy')  | extend isRPMode = iff(mode startswith 'Microsoft.', true, false)  | project definitionId, numberOfPolicies, category, numberOfGroups, isRegulatoryInitiative, definitionType, isRPMode ) on $left.policyAssignmentDefinitionId == $right.definitionId | join kind=leftouter(  policyResources  | where type =~ 'Microsoft.PolicyInsights/PolicyStates'  | extend complianceState = tostring(properties.complianceState)  | extend policyStateResourceId =id, resourceId = tostring(properties.resourceId), policyAssignmentId = tostring(properties.policyAssignmentId), policyDefinitionId = tostring(properties.policyDefinitionId), policySetDefinitionId = tostring(properties.policySetDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), policyDefinitionAction = tostring(properties.policyDefinitionAction), policyDefinitionGroupNames = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic([''])), stateWeight = toint(properties.stateWeight)  | summarize max(stateWeight) by resourceId, policyAssignmentId, policySetDefinitionId  | summarize resourceCounts = count() by policyAssignmentId, policySetDefinitionId, max_stateWeight | extend complianceState = case( max_stateWeight == 300, 'noncompliant', max_stateWeight == 200, 'compliant', max_stateWeight == 100, 'conflict', max_stateWeight == 50, 'exempt', max_stateWeight == 10, 'unknown', 'notapplicable')  | extend pack = pack('complianceState', complianceState, 'resourceCounts', resourceCounts), numberOfNonCompliantResources = toint(iff(complianceState =~ 'NonCompliant', resourceCounts,0))  | summarize numberOfNonCompliantResources = max(numberOfNonCompliantResources), details = makelist(pack) by policyAssignmentId, policySetDefinitionId  | limit 5000 ) on $left.policyAssignmentId == $right.policyAssignmentId | sort by numberOfNonCompliantResources desc | project-away policyAssignmentId1"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%0A%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%0A%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentName%20%3D%20name%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentScope%20%3D%20tostring%28properties.scope%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%2C%20policyAssignmentNotScopes%20%3D%20tolower%28properties.notScopes%29%20%0A%7C%20join%20kind%3Dleftouter%28%0A%20policyResources%0A%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%0A%20%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20type%2C%20numberOfPolicies%20%3D%20array_length%28properties.policyDefinitions%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20numberOfGroups%3D%20array_length%28properties.policyDefinitionGroups%29%2C%20mode%20%3D%20tostring%28properties.mode%29%0A%20%7C%20extend%20isRegulatoryInitiative%20%3D%20iff%28category%20%3D~%20%27Regulatory%20Compliance%27%2C%20true%2C%20false%29%0A%20%7C%20extend%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%0A%20%7C%20extend%20isRPMode%20%3D%20iff%28mode%20startswith%20%27Microsoft.%27%2C%20true%2C%20false%29%0A%20%7C%20project%20definitionId%2C%20numberOfPolicies%2C%20category%2C%20numberOfGroups%2C%20isRegulatoryInitiative%2C%20definitionType%2C%20isRPMode%0A%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId%0A%7C%20join%20kind%3Dleftouter%28%0A%20policyResources%20%0A%20%7C%20where%20type%20%3D~%20%27Microsoft.PolicyInsights%2FPolicyStates%27%0A%20%7C%20extend%20complianceState%20%3D%20tostring%28properties.complianceState%29%0A%20%7C%20extend%20policyStateResourceId%20%3Did%2C%20resourceId%20%3D%20tostring%28properties.resourceId%29%2C%20policyAssignmentId%20%3D%20tostring%28properties.policyAssignmentId%29%2C%20policyDefinitionId%20%3D%20tostring%28properties.policyDefinitionId%29%2C%20policySetDefinitionId%20%3D%20tostring%28properties.policySetDefinitionId%29%2C%20policyDefinitionReferenceId%20%3D%20tostring%28properties.policyDefinitionReferenceId%29%2C%20policyDefinitionAction%20%3D%20tostring%28properties.policyDefinitionAction%29%2C%20policyDefinitionGroupNames%20%3D%20iff%28isnotnull%28properties.policyDefinitionGroupNames%29%2C%20properties.policyDefinitionGroupNames%2C%20dynamic%28%5B%27%27%5D%29%29%2C%20stateWeight%20%3D%20toint%28properties.stateWeight%29%0A%20%7C%20summarize%20max%28stateWeight%29%20by%20resourceId%2C%20policyAssignmentId%2C%20policySetDefinitionId%0A%20%7C%20summarize%20resourceCounts%20%3D%20count%28%29%20by%20policyAssignmentId%2C%20policySetDefinitionId%2C%20max_stateWeight%0A%7C%20extend%20complianceState%20%3D%20case%28%0Amax_stateWeight%20%3D%3D%20300%2C%20%27noncompliant%27%2C%20%0Amax_stateWeight%20%3D%3D%20200%2C%20%27compliant%27%2C%20%0Amax_stateWeight%20%3D%3D%20100%2C%20%27conflict%27%2C%20%0Amax_stateWeight%20%3D%3D%2050%2C%20%27exempt%27%2C%20%0Amax_stateWeight%20%3D%3D%2010%2C%20%27unknown%27%2C%20%0A%27notapplicable%27%29%0A%20%7C%20extend%20pack%20%3D%20pack%28%27complianceState%27%2C%20complianceState%2C%20%27resourceCounts%27%2C%20resourceCounts%29%2C%20numberOfNonCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27NonCompliant%27%2C%20resourceCounts%2C0%29%29%0A%20%7C%20summarize%20numberOfNonCompliantResources%20%3D%20max%28numberOfNonCompliantResources%29%2C%20details%20%3D%20makelist%28pack%29%20by%20policyAssignmentId%2C%20policySetDefinitionId%0A%20%7C%20limit%205000%0A%29%20on%20%24left.policyAssignmentId%20%3D%3D%20%24right.policyAssignmentId%0A%7C%20sort%20by%20numberOfNonCompliantResources%20desc%0A%7C%20project-away%20policyAssignmentId1%0A" target="_blank">portal.azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%0A%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicyAssignments%27%0A%7C%20project%20policyAssignmentId%20%3D%20tolower%28tostring%28id%29%29%2C%20policyAssignmentName%20%3D%20name%2C%20policyAssignmentDisplayName%20%3D%20tostring%28properties.displayName%29%2C%20policyAssignmentScope%20%3D%20tostring%28properties.scope%29%2C%20policyAssignmentDefinitionId%20%3D%20tolower%28properties.policyDefinitionId%29%2C%20policyAssignmentNotScopes%20%3D%20tolower%28properties.notScopes%29%20%0A%7C%20join%20kind%3Dleftouter%28%0A%20policyResources%0A%20%7C%20where%20type%20%3D~%27Microsoft.Authorization%2FPolicySetDefinitions%27%20or%20type%20%3D~%27Microsoft.Authorization%2FPolicyDefinitions%27%0A%20%7C%20project%20definitionId%20%3D%20tolower%28id%29%2C%20type%2C%20numberOfPolicies%20%3D%20array_length%28properties.policyDefinitions%29%2C%20category%20%3D%20tostring%28properties.metadata.category%29%2C%20numberOfGroups%3D%20array_length%28properties.policyDefinitionGroups%29%2C%20mode%20%3D%20tostring%28properties.mode%29%0A%20%7C%20extend%20isRegulatoryInitiative%20%3D%20iff%28category%20%3D~%20%27Regulatory%20Compliance%27%2C%20true%2C%20false%29%0A%20%7C%20extend%20definitionType%20%3D%20iff%28type%20%3D~%20%27Microsoft.Authorization%2FPolicysetDefinitions%27%2C%20%27initiative%27%2C%20%27policy%27%29%0A%20%7C%20extend%20isRPMode%20%3D%20iff%28mode%20startswith%20%27Microsoft.%27%2C%20true%2C%20false%29%0A%20%7C%20project%20definitionId%2C%20numberOfPolicies%2C%20category%2C%20numberOfGroups%2C%20isRegulatoryInitiative%2C%20definitionType%2C%20isRPMode%0A%29%20on%20%24left.policyAssignmentDefinitionId%20%3D%3D%20%24right.definitionId%0A%7C%20join%20kind%3Dleftouter%28%0A%20policyResources%20%0A%20%7C%20where%20type%20%3D~%20%27Microsoft.PolicyInsights%2FPolicyStates%27%0A%20%7C%20extend%20complianceState%20%3D%20tostring%28properties.complianceState%29%0A%20%7C%20extend%20policyStateResourceId%20%3Did%2C%20resourceId%20%3D%20tostring%28properties.resourceId%29%2C%20policyAssignmentId%20%3D%20tostring%28properties.policyAssignmentId%29%2C%20policyDefinitionId%20%3D%20tostring%28properties.policyDefinitionId%29%2C%20policySetDefinitionId%20%3D%20tostring%28properties.policySetDefinitionId%29%2C%20policyDefinitionReferenceId%20%3D%20tostring%28properties.policyDefinitionReferenceId%29%2C%20policyDefinitionAction%20%3D%20tostring%28properties.policyDefinitionAction%29%2C%20policyDefinitionGroupNames%20%3D%20iff%28isnotnull%28properties.policyDefinitionGroupNames%29%2C%20properties.policyDefinitionGroupNames%2C%20dynamic%28%5B%27%27%5D%29%29%2C%20stateWeight%20%3D%20toint%28properties.stateWeight%29%0A%20%7C%20summarize%20max%28stateWeight%29%20by%20resourceId%2C%20policyAssignmentId%2C%20policySetDefinitionId%0A%20%7C%20summarize%20resourceCounts%20%3D%20count%28%29%20by%20policyAssignmentId%2C%20policySetDefinitionId%2C%20max_stateWeight%0A%7C%20extend%20complianceState%20%3D%20case%28%0Amax_stateWeight%20%3D%3D%20300%2C%20%27noncompliant%27%2C%20%0Amax_stateWeight%20%3D%3D%20200%2C%20%27compliant%27%2C%20%0Amax_stateWeight%20%3D%3D%20100%2C%20%27conflict%27%2C%20%0Amax_stateWeight%20%3D%3D%2050%2C%20%27exempt%27%2C%20%0Amax_stateWeight%20%3D%3D%2010%2C%20%27unknown%27%2C%20%0A%27notapplicable%27%29%0A%20%7C%20extend%20pack%20%3D%20pack%28%27complianceState%27%2C%20complianceState%2C%20%27resourceCounts%27%2C%20resourceCounts%29%2C%20numberOfNonCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27NonCompliant%27%2C%20resourceCounts%2C0%29%29%0A%20%7C%20summarize%20numberOfNonCompliantResources%20%3D%20max%28numberOfNonCompliantResources%29%2C%20details%20%3D%20makelist%28pack%29%20by%20policyAssignmentId%2C%20policySetDefinitionId%0A%20%7C%20limit%205000%0A%29%20on%20%24left.policyAssignmentId%20%3D%3D%20%24right.policyAssignmentId%0A%7C%20sort%20by%20numberOfNonCompliantResources%20desc%0A%7C%20project-away%20policyAssignmentId1%0A" target="_blank">portal.Azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/PolicyResources" target="_blank">portal.Azure.cn</a>

---

### Breakdown of compliance information for each policy within a given built-in or custom policySetDefinition

This sample query gets aggregated compliance information for each policy within a given policySetDefinition assigned to your environment. See information like: policy definition payload, definition reference ID, policy definition parameters, policy definition effects, total resources evaluated for the definition and number of resources evaluated to each of the compliance states.

```kusto
policyResources
| where type =~ 'Microsoft.Authorization/PolicySetDefinitions'
| where id =~ '/providers/microsoft.authorization/policysetdefinitions/setDefinitionId'
| extend policysetDefId = tolower(id)| extend policyDefinitions = properties.policyDefinitions
|  mv-expand policyDefinition = policyDefinitions limit 400
|  extend policyDefinitionId = tolower(policyDefinition.policyDefinitionId)
|  extend policyDefinitionReferenceId = tolower(policyDefinition.policyDefinitionReferenceId)
|  extend policyDefinitionReferenceParameters = policyDefinition.parameters
|  extend groupNames = policyDefinition.groupNames
|  join kind = leftouter(
 policyResources
 |  where type =~ 'Microsoft.Authorization/Policydefinitions'
 |  extend policyDefinitionId = tolower(id)) on $left.policyDefinitionId == $right.policyDefinitionId
 |  project id = tolower(id1), name = name1, properties = properties1, policyDefinitionReferenceId = tolower(policyDefinitionReferenceId), policyDefinitionReferenceParameters, groupNames
 | join kind = leftouter(
 policyResources
 |  where type =~ 'Microsoft.PolicyInsights/PolicyStates'
 |  extend resourceId = tostring(properties.resourceId)
 |  extend complianceState = tostring(properties.complianceState)
 |  extend policyAssignmentId = tostring(properties.policyAssignmentId),
policyDefinitionId = tostring(properties.policyDefinitionId),
policySetDefinitionId = tostring(properties.policySetDefinitionId),
policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId),
policyDefinitionAction = tostring(properties.policyDefinitionAction),
policyDefinitionGroupNames = iff(isnotnull(properties.policyDefinitionGroupNames),
properties.policyDefinitionGroupNames, dynamic([''])),
stateWeight = case(
complianceState == 'Noncompliant', 300,
complianceState == 'Compliant', 200,
complianceState == 'Conflict', 100,
complianceState == 'Exempt', 500,
complianceState == 'Unknown', 10,
0)
 |  where policyAssignmentId  =~ '/subscriptions/subscriptionId/providers/microsoft.authorization/policyassignments/policyInitiativeName'
 |  summarize resourceCounts = count() by policyAssignmentId, policyDefinitionId, policyDefinitionReferenceId, tostring(policyDefinitionGroupNames), policyDefinitionAction, complianceState
 |  extend Pack = pack('complianceState', complianceState, 'resourceCounts', resourceCounts), numberOfNonCompliantResources = toint(iff(complianceState =~ 'NonCompliant', resourceCounts, 0)),  numberOfCompliantResources = toint(iff(complianceState =~ 'Compliant', resourceCounts, 0)),  numberOfConflictResources = toint(iff(complianceState =~ 'Conflict', resourceCounts, 0)),  numberOfExemptResources = toint(iff(complianceState =~ 'Exempt', resourceCounts, 0)),  numberOfUnknownResources = toint(iff(complianceState =~ 'Unknown', resourceCounts, 0))
 |  extend totalResources = todouble(numberOfNonCompliantResources + numberOfCompliantResources + numberOfConflictResources + numberOfExemptResources + numberOfUnknownResources)
 |  summarize numberOfNonCompliantResources = max(numberOfNonCompliantResources), numberOfCompliantResources=max(numberOfCompliantResources), numberOfConflictResources=max(numberOfConflictResources), numberOfExemptResources =max(numberOfExemptResources), numberOfUnknownResources = max(numberOfUnknownResources), totalResources=sum(totalResources), details = makelist(Pack) by policyAssignmentId, policyDefinitionId, policyDefinitionReferenceId, policyDefinitionGroupNames, policyDefinitionAction
 |  order by numberOfNonCompliantResources desc, policyAssignmentId asc
 |  limit 5000     ) on $left.id == $right.policyDefinitionId and $left.policyDefinitionReferenceId == $right.policyDefinitionReferenceId
 |  project-away policyDefinitionReferenceId1

```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "policyResources | where type =~ 'Microsoft.Authorization/PolicySetDefinitions' | where id =~ '/providers/microsoft.authorization/policysetdefinitions/setDefinitionId' | extend policysetDefId = tolower(id)| extend policyDefinitions = properties.policyDefinitions |  mv-expand policyDefinition = policyDefinitions limit 400 |  extend policyDefinitionId = tolower(policyDefinition.policyDefinitionId) |  extend policyDefinitionReferenceId = tolower(policyDefinition.policyDefinitionReferenceId) |  extend policyDefinitionReferenceParameters = policyDefinition.parameters |  extend groupNames = policyDefinition.groupNames |  join kind = leftouter(  policyResources  |  where type =~ 'Microsoft.Authorization/Policydefinitions'  |  extend policyDefinitionId = tolower(id)) on $left.policyDefinitionId == $right.policyDefinitionId  |  project id = tolower(id1), name = name1, properties = properties1, policyDefinitionReferenceId = tolower(policyDefinitionReferenceId), policyDefinitionReferenceParameters, groupNames  | join kind = leftouter(  policyResources  |  where type =~ 'Microsoft.PolicyInsights/PolicyStates'  |  extend resourceId = tostring(properties.resourceId)  |  extend complianceState = tostring(properties.complianceState)  |  extend policyAssignmentId = tostring(properties.policyAssignmentId), policyDefinitionId = tostring(properties.policyDefinitionId), policySetDefinitionId = tostring(properties.policySetDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), policyDefinitionAction = tostring(properties.policyDefinitionAction), policyDefinitionGroupNames = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic([''])), stateWeight = case( complianceState == 'Noncompliant', 300, complianceState == 'Compliant', 200, complianceState == 'Conflict', 100, complianceState == 'Exempt', 500, complianceState == 'Unknown', 10, 0)  |  where policyAssignmentId  =~ '/subscriptions/subscriptionId/providers/microsoft.authorization/policyassignments/policyInitiativeName'  |  summarize resourceCounts = count() by policyAssignmentId, policyDefinitionId, policyDefinitionReferenceId, tostring(policyDefinitionGroupNames), policyDefinitionAction, complianceState  |  extend Pack = pack('complianceState', complianceState, 'resourceCounts', resourceCounts), numberOfNonCompliantResources = toint(iff(complianceState =~ 'NonCompliant', resourceCounts, 0)),  numberOfCompliantResources = toint(iff(complianceState =~ 'Compliant', resourceCounts, 0)),  numberOfConflictResources = toint(iff(complianceState =~ 'Conflict', resourceCounts, 0)),  numberOfExemptResources = toint(iff(complianceState =~ 'Exempt', resourceCounts, 0)),  numberOfUnknownResources = toint(iff(complianceState =~ 'Unknown', resourceCounts, 0))  |  extend totalResources = todouble(numberOfNonCompliantResources + numberOfCompliantResources + numberOfConflictResources + numberOfExemptResources + numberOfUnknownResources)  |  summarize numberOfNonCompliantResources = max(numberOfNonCompliantResources), numberOfCompliantResources=max(numberOfCompliantResources), numberOfConflictResources=max(numberOfConflictResources), numberOfExemptResources =max(numberOfExemptResources), numberOfUnknownResources = max(numberOfUnknownResources), totalResources=sum(totalResources), details = makelist(Pack) by policyAssignmentId, policyDefinitionId, policyDefinitionReferenceId, policyDefinitionGroupNames, policyDefinitionAction  |  order by numberOfNonCompliantResources desc, policyAssignmentId asc  |  limit 5000     ) on $left.id == $right.policyDefinitionId and $left.policyDefinitionReferenceId == $right.policyDefinitionReferenceId  |  project-away policyDefinitionReferenceId1"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "policyResources | where type =~ 'Microsoft.Authorization/PolicySetDefinitions' | where id =~ '/providers/microsoft.authorization/policysetdefinitions/setDefinitionId' | extend policysetDefId = tolower(id)| extend policyDefinitions = properties.policyDefinitions |  mv-expand policyDefinition = policyDefinitions limit 400 |  extend policyDefinitionId = tolower(policyDefinition.policyDefinitionId) |  extend policyDefinitionReferenceId = tolower(policyDefinition.policyDefinitionReferenceId) |  extend policyDefinitionReferenceParameters = policyDefinition.parameters |  extend groupNames = policyDefinition.groupNames |  join kind = leftouter(  policyResources  |  where type =~ 'Microsoft.Authorization/Policydefinitions'  |  extend policyDefinitionId = tolower(id)) on $left.policyDefinitionId == $right.policyDefinitionId  |  project id = tolower(id1), name = name1, properties = properties1, policyDefinitionReferenceId = tolower(policyDefinitionReferenceId), policyDefinitionReferenceParameters, groupNames  | join kind = leftouter(  policyResources  |  where type =~ 'Microsoft.PolicyInsights/PolicyStates'  |  extend resourceId = tostring(properties.resourceId)  |  extend complianceState = tostring(properties.complianceState)  |  extend policyAssignmentId = tostring(properties.policyAssignmentId), policyDefinitionId = tostring(properties.policyDefinitionId), policySetDefinitionId = tostring(properties.policySetDefinitionId), policyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId), policyDefinitionAction = tostring(properties.policyDefinitionAction), policyDefinitionGroupNames = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic([''])), stateWeight = case( complianceState == 'Noncompliant', 300, complianceState == 'Compliant', 200, complianceState == 'Conflict', 100, complianceState == 'Exempt', 500, complianceState == 'Unknown', 10, 0)  |  where policyAssignmentId  =~ '/subscriptions/subscriptionId/providers/microsoft.authorization/policyassignments/policyInitiativeName'  |  summarize resourceCounts = count() by policyAssignmentId, policyDefinitionId, policyDefinitionReferenceId, tostring(policyDefinitionGroupNames), policyDefinitionAction, complianceState  |  extend Pack = pack('complianceState', complianceState, 'resourceCounts', resourceCounts), numberOfNonCompliantResources = toint(iff(complianceState =~ 'NonCompliant', resourceCounts, 0)),  numberOfCompliantResources = toint(iff(complianceState =~ 'Compliant', resourceCounts, 0)),  numberOfConflictResources = toint(iff(complianceState =~ 'Conflict', resourceCounts, 0)),  numberOfExemptResources = toint(iff(complianceState =~ 'Exempt', resourceCounts, 0)),  numberOfUnknownResources = toint(iff(complianceState =~ 'Unknown', resourceCounts, 0))  |  extend totalResources = todouble(numberOfNonCompliantResources + numberOfCompliantResources + numberOfConflictResources + numberOfExemptResources + numberOfUnknownResources)  |  summarize numberOfNonCompliantResources = max(numberOfNonCompliantResources), numberOfCompliantResources=max(numberOfCompliantResources), numberOfConflictResources=max(numberOfConflictResources), numberOfExemptResources =max(numberOfExemptResources), numberOfUnknownResources = max(numberOfUnknownResources), totalResources=sum(totalResources), details = makelist(Pack) by policyAssignmentId, policyDefinitionId, policyDefinitionReferenceId, policyDefinitionGroupNames, policyDefinitionAction  |  order by numberOfNonCompliantResources desc, policyAssignmentId asc  |  limit 5000     ) on $left.id == $right.policyDefinitionId and $left.policyDefinitionReferenceId == $right.policyDefinitionReferenceId  |  project-away policyDefinitionReferenceId1"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%0A%7C%20where%20type%20%3D~%20%27Microsoft.Authorization%2FPolicySetDefinitions%27%0A%7C%20where%20id%20%3D~%20%27%2Fproviders%2Fmicrosoft.authorization%2Fpolicysetdefinitions%2FsetDefinitionId%27%0A%7C%20extend%20policysetDefId%20%3D%20tolower%28id%29%7C%20extend%20policyDefinitions%20%3D%20properties.policyDefinitions%0A%7C%20%20mv-expand%20policyDefinition%20%3D%20policyDefinitions%20limit%20400%0A%7C%20%20extend%20policyDefinitionId%20%3D%20tolower%28policyDefinition.policyDefinitionId%29%0A%7C%20%20extend%20policyDefinitionReferenceId%20%3D%20tolower%28policyDefinition.policyDefinitionReferenceId%29%0A%7C%20%20extend%20policyDefinitionReferenceParameters%20%3D%20policyDefinition.parameters%0A%7C%20%20extend%20groupNames%20%3D%20policyDefinition.groupNames%0A%7C%20%20join%20kind%20%3D%20leftouter%28%0A%20policyResources%0A%20%7C%20%20where%20type%20%3D~%20%27Microsoft.Authorization%2FPolicydefinitions%27%0A%20%7C%20%20extend%20policyDefinitionId%20%3D%20tolower%28id%29%29%20on%20%24left.policyDefinitionId%20%3D%3D%20%24right.policyDefinitionId%0A%20%7C%20%20project%20id%20%3D%20tolower%28id1%29%2C%20name%20%3D%20name1%2C%20properties%20%3D%20properties1%2C%20policyDefinitionReferenceId%20%3D%20tolower%28policyDefinitionReferenceId%29%2C%20policyDefinitionReferenceParameters%2C%20groupNames%0A%20%7C%20join%20kind%20%3D%20leftouter%28%0A%20policyResources%0A%20%7C%20%20where%20type%20%3D~%20%27Microsoft.PolicyInsights%2FPolicyStates%27%0A%20%7C%20%20extend%20resourceId%20%3D%20tostring%28properties.resourceId%29%0A%20%7C%20%20extend%20complianceState%20%3D%20tostring%28properties.complianceState%29%0A%20%7C%20%20extend%20policyAssignmentId%20%3D%20tostring%28properties.policyAssignmentId%29%2C%0ApolicyDefinitionId%20%3D%20tostring%28properties.policyDefinitionId%29%2C%0ApolicySetDefinitionId%20%3D%20tostring%28properties.policySetDefinitionId%29%2C%0ApolicyDefinitionReferenceId%20%3D%20tostring%28properties.policyDefinitionReferenceId%29%2C%0ApolicyDefinitionAction%20%3D%20tostring%28properties.policyDefinitionAction%29%2C%0ApolicyDefinitionGroupNames%20%3D%20iff%28isnotnull%28properties.policyDefinitionGroupNames%29%2C%0Aproperties.policyDefinitionGroupNames%2C%20dynamic%28%5B%27%27%5D%29%29%2C%0AstateWeight%20%3D%20case%28%0AcomplianceState%20%3D%3D%20%27Noncompliant%27%2C%20300%2C%0AcomplianceState%20%3D%3D%20%27Compliant%27%2C%20200%2C%0AcomplianceState%20%3D%3D%20%27Conflict%27%2C%20100%2C%0AcomplianceState%20%3D%3D%20%27Exempt%27%2C%20500%2C%0AcomplianceState%20%3D%3D%20%27Unknown%27%2C%2010%2C%0A0%29%0A%20%7C%20%20where%20policyAssignmentId%20%20%3D~%20%27%2Fsubscriptions%2FsubscriptionId%2Fproviders%2Fmicrosoft.authorization%2Fpolicyassignments%2FpolicyInitiativeName%27%0A%20%7C%20%20summarize%20resourceCounts%20%3D%20count%28%29%20by%20policyAssignmentId%2C%20policyDefinitionId%2C%20policyDefinitionReferenceId%2C%20tostring%28policyDefinitionGroupNames%29%2C%20policyDefinitionAction%2C%20complianceState%0A%20%7C%20%20extend%20Pack%20%3D%20pack%28%27complianceState%27%2C%20complianceState%2C%20%27resourceCounts%27%2C%20resourceCounts%29%2C%20numberOfNonCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27NonCompliant%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Compliant%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfConflictResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Conflict%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfExemptResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Exempt%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfUnknownResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Unknown%27%2C%20resourceCounts%2C%200%29%29%0A%20%7C%20%20extend%20totalResources%20%3D%20todouble%28numberOfNonCompliantResources%20%2B%20numberOfCompliantResources%20%2B%20numberOfConflictResources%20%2B%20numberOfExemptResources%20%2B%20numberOfUnknownResources%29%0A%20%7C%20%20summarize%20numberOfNonCompliantResources%20%3D%20max%28numberOfNonCompliantResources%29%2C%20numberOfCompliantResources%3Dmax%28numberOfCompliantResources%29%2C%20numberOfConflictResources%3Dmax%28numberOfConflictResources%29%2C%20numberOfExemptResources%20%3Dmax%28numberOfExemptResources%29%2C%20numberOfUnknownResources%20%3D%20max%28numberOfUnknownResources%29%2C%20totalResources%3Dsum%28totalResources%29%2C%20details%20%3D%20makelist%28Pack%29%20by%20policyAssignmentId%2C%20policyDefinitionId%2C%20policyDefinitionReferenceId%2C%20policyDefinitionGroupNames%2C%20policyDefinitionAction%0A%20%7C%20%20order%20by%20numberOfNonCompliantResources%20desc%2C%20policyAssignmentId%20asc%0A%20%7C%20%20limit%205000%20%20%20%20%20%29%20on%20%24left.id%20%3D%3D%20%24right.policyDefinitionId%20and%20%24left.policyDefinitionReferenceId%20%3D%3D%20%24right.policyDefinitionReferenceId%0A%20%7C%20%20project-away%20policyDefinitionReferenceId1" target="_blank">portal.azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%0A%7C%20where%20type%20%3D~%20%27Microsoft.Authorization%2FPolicySetDefinitions%27%0A%7C%20where%20id%20%3D~%20%27%2Fproviders%2Fmicrosoft.authorization%2Fpolicysetdefinitions%2FsetDefinitionId%27%0A%7C%20extend%20policysetDefId%20%3D%20tolower%28id%29%7C%20extend%20policyDefinitions%20%3D%20properties.policyDefinitions%0A%7C%20%20mv-expand%20policyDefinition%20%3D%20policyDefinitions%20limit%20400%0A%7C%20%20extend%20policyDefinitionId%20%3D%20tolower%28policyDefinition.policyDefinitionId%29%0A%7C%20%20extend%20policyDefinitionReferenceId%20%3D%20tolower%28policyDefinition.policyDefinitionReferenceId%29%0A%7C%20%20extend%20policyDefinitionReferenceParameters%20%3D%20policyDefinition.parameters%0A%7C%20%20extend%20groupNames%20%3D%20policyDefinition.groupNames%0A%7C%20%20join%20kind%20%3D%20leftouter%28%0A%20policyResources%0A%20%7C%20%20where%20type%20%3D~%20%27Microsoft.Authorization%2FPolicydefinitions%27%0A%20%7C%20%20extend%20policyDefinitionId%20%3D%20tolower%28id%29%29%20on%20%24left.policyDefinitionId%20%3D%3D%20%24right.policyDefinitionId%0A%20%7C%20%20project%20id%20%3D%20tolower%28id1%29%2C%20name%20%3D%20name1%2C%20properties%20%3D%20properties1%2C%20policyDefinitionReferenceId%20%3D%20tolower%28policyDefinitionReferenceId%29%2C%20policyDefinitionReferenceParameters%2C%20groupNames%0A%20%7C%20join%20kind%20%3D%20leftouter%28%0A%20policyResources%0A%20%7C%20%20where%20type%20%3D~%20%27Microsoft.PolicyInsights%2FPolicyStates%27%0A%20%7C%20%20extend%20resourceId%20%3D%20tostring%28properties.resourceId%29%0A%20%7C%20%20extend%20complianceState%20%3D%20tostring%28properties.complianceState%29%0A%20%7C%20%20extend%20policyAssignmentId%20%3D%20tostring%28properties.policyAssignmentId%29%2C%0ApolicyDefinitionId%20%3D%20tostring%28properties.policyDefinitionId%29%2C%0ApolicySetDefinitionId%20%3D%20tostring%28properties.policySetDefinitionId%29%2C%0ApolicyDefinitionReferenceId%20%3D%20tostring%28properties.policyDefinitionReferenceId%29%2C%0ApolicyDefinitionAction%20%3D%20tostring%28properties.policyDefinitionAction%29%2C%0ApolicyDefinitionGroupNames%20%3D%20iff%28isnotnull%28properties.policyDefinitionGroupNames%29%2C%0Aproperties.policyDefinitionGroupNames%2C%20dynamic%28%5B%27%27%5D%29%29%2C%0AstateWeight%20%3D%20case%28%0AcomplianceState%20%3D%3D%20%27Noncompliant%27%2C%20300%2C%0AcomplianceState%20%3D%3D%20%27Compliant%27%2C%20200%2C%0AcomplianceState%20%3D%3D%20%27Conflict%27%2C%20100%2C%0AcomplianceState%20%3D%3D%20%27Exempt%27%2C%20500%2C%0AcomplianceState%20%3D%3D%20%27Unknown%27%2C%2010%2C%0A0%29%0A%20%7C%20%20where%20policyAssignmentId%20%20%3D~%20%27%2Fsubscriptions%2FsubscriptionId%2Fproviders%2Fmicrosoft.authorization%2Fpolicyassignments%2FpolicyInitiativeName%27%0A%20%7C%20%20summarize%20resourceCounts%20%3D%20count%28%29%20by%20policyAssignmentId%2C%20policyDefinitionId%2C%20policyDefinitionReferenceId%2C%20tostring%28policyDefinitionGroupNames%29%2C%20policyDefinitionAction%2C%20complianceState%0A%20%7C%20%20extend%20Pack%20%3D%20pack%28%27complianceState%27%2C%20complianceState%2C%20%27resourceCounts%27%2C%20resourceCounts%29%2C%20numberOfNonCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27NonCompliant%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Compliant%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfConflictResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Conflict%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfExemptResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Exempt%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfUnknownResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Unknown%27%2C%20resourceCounts%2C%200%29%29%0A%20%7C%20%20extend%20totalResources%20%3D%20todouble%28numberOfNonCompliantResources%20%2B%20numberOfCompliantResources%20%2B%20numberOfConflictResources%20%2B%20numberOfExemptResources%20%2B%20numberOfUnknownResources%29%0A%20%7C%20%20summarize%20numberOfNonCompliantResources%20%3D%20max%28numberOfNonCompliantResources%29%2C%20numberOfCompliantResources%3Dmax%28numberOfCompliantResources%29%2C%20numberOfConflictResources%3Dmax%28numberOfConflictResources%29%2C%20numberOfExemptResources%20%3Dmax%28numberOfExemptResources%29%2C%20numberOfUnknownResources%20%3D%20max%28numberOfUnknownResources%29%2C%20totalResources%3Dsum%28totalResources%29%2C%20details%20%3D%20makelist%28Pack%29%20by%20policyAssignmentId%2C%20policyDefinitionId%2C%20policyDefinitionReferenceId%2C%20policyDefinitionGroupNames%2C%20policyDefinitionAction%0A%20%7C%20%20order%20by%20numberOfNonCompliantResources%20desc%2C%20policyAssignmentId%20asc%0A%20%7C%20%20limit%205000%20%20%20%20%20%29%20on%20%24left.id%20%3D%3D%20%24right.policyDefinitionId%20and%20%24left.policyDefinitionReferenceId%20%3D%3D%20%24right.policyDefinitionReferenceId%0A%20%7C%20%20project-away%20policyDefinitionReferenceId1" target="_blank">portal.azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/policyResources%0A%7C%20where%20type%20%3D~%20%27Microsoft.Authorization%2FPolicySetDefinitions%27%0A%7C%20where%20id%20%3D~%20%27%2Fproviders%2Fmicrosoft.authorization%2Fpolicysetdefinitions%2FsetDefinitionId%27%0A%7C%20extend%20policysetDefId%20%3D%20tolower%28id%29%7C%20extend%20policyDefinitions%20%3D%20properties.policyDefinitions%0A%7C%20%20mv-expand%20policyDefinition%20%3D%20policyDefinitions%20limit%20400%0A%7C%20%20extend%20policyDefinitionId%20%3D%20tolower%28policyDefinition.policyDefinitionId%29%0A%7C%20%20extend%20policyDefinitionReferenceId%20%3D%20tolower%28policyDefinition.policyDefinitionReferenceId%29%0A%7C%20%20extend%20policyDefinitionReferenceParameters%20%3D%20policyDefinition.parameters%0A%7C%20%20extend%20groupNames%20%3D%20policyDefinition.groupNames%0A%7C%20%20join%20kind%20%3D%20leftouter%28%0A%20policyResources%0A%20%7C%20%20where%20type%20%3D~%20%27Microsoft.Authorization%2FPolicydefinitions%27%0A%20%7C%20%20extend%20policyDefinitionId%20%3D%20tolower%28id%29%29%20on%20%24left.policyDefinitionId%20%3D%3D%20%24right.policyDefinitionId%0A%20%7C%20%20project%20id%20%3D%20tolower%28id1%29%2C%20name%20%3D%20name1%2C%20properties%20%3D%20properties1%2C%20policyDefinitionReferenceId%20%3D%20tolower%28policyDefinitionReferenceId%29%2C%20policyDefinitionReferenceParameters%2C%20groupNames%0A%20%7C%20join%20kind%20%3D%20leftouter%28%0A%20policyResources%0A%20%7C%20%20where%20type%20%3D~%20%27Microsoft.PolicyInsights%2FPolicyStates%27%0A%20%7C%20%20extend%20resourceId%20%3D%20tostring%28properties.resourceId%29%0A%20%7C%20%20extend%20complianceState%20%3D%20tostring%28properties.complianceState%29%0A%20%7C%20%20extend%20policyAssignmentId%20%3D%20tostring%28properties.policyAssignmentId%29%2C%0ApolicyDefinitionId%20%3D%20tostring%28properties.policyDefinitionId%29%2C%0ApolicySetDefinitionId%20%3D%20tostring%28properties.policySetDefinitionId%29%2C%0ApolicyDefinitionReferenceId%20%3D%20tostring%28properties.policyDefinitionReferenceId%29%2C%0ApolicyDefinitionAction%20%3D%20tostring%28properties.policyDefinitionAction%29%2C%0ApolicyDefinitionGroupNames%20%3D%20iff%28isnotnull%28properties.policyDefinitionGroupNames%29%2C%0Aproperties.policyDefinitionGroupNames%2C%20dynamic%28%5B%27%27%5D%29%29%2C%0AstateWeight%20%3D%20case%28%0AcomplianceState%20%3D%3D%20%27Noncompliant%27%2C%20300%2C%0AcomplianceState%20%3D%3D%20%27Compliant%27%2C%20200%2C%0AcomplianceState%20%3D%3D%20%27Conflict%27%2C%20100%2C%0AcomplianceState%20%3D%3D%20%27Exempt%27%2C%20500%2C%0AcomplianceState%20%3D%3D%20%27Unknown%27%2C%2010%2C%0A0%29%0A%20%7C%20%20where%20policyAssignmentId%20%20%3D~%20%27%2Fsubscriptions%2FsubscriptionId%2Fproviders%2Fmicrosoft.authorization%2Fpolicyassignments%2FpolicyInitiativeName%27%0A%20%7C%20%20summarize%20resourceCounts%20%3D%20count%28%29%20by%20policyAssignmentId%2C%20policyDefinitionId%2C%20policyDefinitionReferenceId%2C%20tostring%28policyDefinitionGroupNames%29%2C%20policyDefinitionAction%2C%20complianceState%0A%20%7C%20%20extend%20Pack%20%3D%20pack%28%27complianceState%27%2C%20complianceState%2C%20%27resourceCounts%27%2C%20resourceCounts%29%2C%20numberOfNonCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27NonCompliant%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfCompliantResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Compliant%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfConflictResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Conflict%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfExemptResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Exempt%27%2C%20resourceCounts%2C%200%29%29%2C%20%20numberOfUnknownResources%20%3D%20toint%28iff%28complianceState%20%3D~%20%27Unknown%27%2C%20resourceCounts%2C%200%29%29%0A%20%7C%20%20extend%20totalResources%20%3D%20todouble%28numberOfNonCompliantResources%20%2B%20numberOfCompliantResources%20%2B%20numberOfConflictResources%20%2B%20numberOfExemptResources%20%2B%20numberOfUnknownResources%29%0A%20%7C%20%20summarize%20numberOfNonCompliantResources%20%3D%20max%28numberOfNonCompliantResources%29%2C%20numberOfCompliantResources%3Dmax%28numberOfCompliantResources%29%2C%20numberOfConflictResources%3Dmax%28numberOfConflictResources%29%2C%20numberOfExemptResources%20%3Dmax%28numberOfExemptResources%29%2C%20numberOfUnknownResources%20%3D%20max%28numberOfUnknownResources%29%2C%20totalResources%3Dsum%28totalResources%29%2C%20details%20%3D%20makelist%28Pack%29%20by%20policyAssignmentId%2C%20policyDefinitionId%2C%20policyDefinitionReferenceId%2C%20policyDefinitionGroupNames%2C%20policyDefinitionAction%0A%20%7C%20%20order%20by%20numberOfNonCompliantResources%20desc%2C%20policyAssignmentId%20asc%0A%20%7C%20%20limit%205000%20%20%20%20%20%29%20on%20%24left.id%20%3D%3D%20%24right.policyDefinitionId%20and%20%24left.policyDefinitionReferenceId%20%3D%3D%20%24right.policyDefinitionReferenceId%0A%20%7C%20%20project-away%20policyDefinitionReferenceId1" target="_blank">portal.azure.cn</a>

---

### Get all the compliance information for storage accounts with certain tags

This sample query gets compliance information for storage accounts based on a specific tag.

```kusto
resources
| where type =~ "Microsoft.Storage/storageAccounts"
| where tags['clusterName'] =~ 'tagname'
| extend storageAccountId = tolower(id)
| join kind=leftouter(
    policyresources
    | where ['type'] =~ "Microsoft.PolicyInsights/policyStates"
    | project storageAccountId = tolower(properties.resourceId), policyStatesProperties = properties, resourceType = tostring(properties.resourceType)
) on $left.storageAccountId == $right.storageAccountId
| project-away storageAccountId, storageAccountId1
| extend policyAssignmentId = tostring(policyStatesProperties.policyAssignmentId),
  policyAssignmentName = tostring(policyStatesProperties.policyAssignmentName),
  policyDefinitionId = tostring(policyStatesProperties.policyDefinitionId),
  policyDefinitionName = tostring(policyStatesProperties.policyDefinitionName),
  policySetDefinitionName = tostring(policyStatesProperties.policySetDefinitionName),
  evaluationTime = tostring(policyStatesProperties.timestamp),
  complianceState = tostring(policyStatesProperties.complianceState)
```

# [Azure CLI](#tab/azure-cli)

```azurecli-interactive
az graph query -q "resources | where type =~ "Microsoft.Storage/storageAccounts" | where tags['clusterName'] =~ 'tagname' | extend storageAccountId = tolower(id) | join kind=leftouter(     policyresources     | where ['type'] =~ "Microsoft.PolicyInsights/policyStates"     | project storageAccountId = tolower(properties.resourceId), policyStatesProperties = properties, resourceType = tostring(properties.resourceType) ) on $left.storageAccountId == $right.storageAccountId | project-away storageAccountId, storageAccountId1 | extend policyAssignmentId = tostring(policyStatesProperties.policyAssignmentId),   policyAssignmentName = tostring(policyStatesProperties.policyAssignmentName),   policyDefinitionId = tostring(policyStatesProperties.policyDefinitionId),   policyDefinitionName = tostring(policyStatesProperties.policyDefinitionName),   policySetDefinitionName = tostring(policyStatesProperties.policySetDefinitionName),   evaluationTime = tostring(policyStatesProperties.timestamp),   complianceState = tostring(policyStatesProperties.complianceState)"
```

# [Azure PowerShell](#tab/azure-powershell)

```azurepowershell-interactive
Search-AzGraph -Query "resources | where type =~ "Microsoft.Storage/storageAccounts" | where tags['clusterName'] =~ 'tagname' | extend storageAccountId = tolower(id) | join kind=leftouter(     policyresources     | where ['type'] =~ "Microsoft.PolicyInsights/policyStates"     | project storageAccountId = tolower(properties.resourceId), policyStatesProperties = properties, resourceType = tostring(properties.resourceType) ) on $left.storageAccountId == $right.storageAccountId | project-away storageAccountId, storageAccountId1 | extend policyAssignmentId = tostring(policyStatesProperties.policyAssignmentId),   policyAssignmentName = tostring(policyStatesProperties.policyAssignmentName),   policyDefinitionId = tostring(policyStatesProperties.policyDefinitionId),   policyDefinitionName = tostring(policyStatesProperties.policyDefinitionName),   policySetDefinitionName = tostring(policyStatesProperties.policySetDefinitionName),   evaluationTime = tostring(policyStatesProperties.timestamp),   complianceState = tostring(policyStatesProperties.complianceState)"
```

# [Portal](#tab/azure-portal)

:::image type="icon" source="../../../../articles/governance/resource-graph/media/resource-graph-small.png"::: Try this query in Azure Resource Graph Explorer:

- Azure portal: <a href="https://portal.azure.com/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/resources%0A%7C%20where%20type%20%3D~%20%22Microsoft.Storage%2FstorageAccounts%22%0A%7C%20where%20tags%5B%27clusterName%27%5D%20%3D~%20%27tagname%27%0A%7C%20extend%20storageAccountId%20%3D%20tolower%28id%29%0A%7C%20join%20kind%3Dleftouter%28%0A%20%20%20%20policyresources%0A%20%20%20%20%7C%20where%20%5B%27type%27%5D%20%3D~%20%22Microsoft.PolicyInsights%2FpolicyStates%22%0A%20%20%20%20%7C%20project%20storageAccountId%20%3D%20tolower%28properties.resourceId%29%2C%20policyStatesProperties%20%3D%20properties%2C%20resourceType%20%3D%20tostring%28properties.resourceType%29%0A%29%20on%20%24left.storageAccountId%20%3D%3D%20%24right.storageAccountId%0A%7C%20project-away%20storageAccountId%2C%20storageAccountId1%0A%7C%20extend%20policyAssignmentId%20%3D%20tostring%28policyStatesProperties.policyAssignmentId%29%2C%0A%20%20policyAssignmentName%20%3D%20tostring%28policyStatesProperties.policyAssignmentName%29%2C%0A%20%20policyDefinitionId%20%3D%20tostring%28policyStatesProperties.policyDefinitionId%29%2C%0A%20%20policyDefinitionName%20%3D%20tostring%28policyStatesProperties.policyDefinitionName%29%2C%0A%20%20policySetDefinitionName%20%3D%20tostring%28policyStatesProperties.policySetDefinitionName%29%2C%0A%20%20evaluationTime%20%3D%20tostring%28policyStatesProperties.timestamp%29%2C%0A%20%20complianceState%20%3D%20tostring%28policyStatesProperties.complianceState%29%0A" target="_blank">portal.azure.com</a>
- Azure Government portal: <a href="https://portal.azure.us/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/resources%0A%7C%20where%20type%20%3D~%20%22Microsoft.Storage%2FstorageAccounts%22%0A%7C%20where%20tags%5B%27clusterName%27%5D%20%3D~%20%27tagname%27%0A%7C%20extend%20storageAccountId%20%3D%20tolower%28id%29%0A%7C%20join%20kind%3Dleftouter%28%0A%20%20%20%20policyresources%0A%20%20%20%20%7C%20where%20%5B%27type%27%5D%20%3D~%20%22Microsoft.PolicyInsights%2FpolicyStates%22%0A%20%20%20%20%7C%20project%20storageAccountId%20%3D%20tolower%28properties.resourceId%29%2C%20policyStatesProperties%20%3D%20properties%2C%20resourceType%20%3D%20tostring%28properties.resourceType%29%0A%29%20on%20%24left.storageAccountId%20%3D%3D%20%24right.storageAccountId%0A%7C%20project-away%20storageAccountId%2C%20storageAccountId1%0A%7C%20extend%20policyAssignmentId%20%3D%20tostring%28policyStatesProperties.policyAssignmentId%29%2C%0A%20%20policyAssignmentName%20%3D%20tostring%28policyStatesProperties.policyAssignmentName%29%2C%0A%20%20policyDefinitionId%20%3D%20tostring%28policyStatesProperties.policyDefinitionId%29%2C%0A%20%20policyDefinitionName%20%3D%20tostring%28policyStatesProperties.policyDefinitionName%29%2C%0A%20%20policySetDefinitionName%20%3D%20tostring%28policyStatesProperties.policySetDefinitionName%29%2C%0A%20%20evaluationTime%20%3D%20tostring%28policyStatesProperties.timestamp%29%2C%0A%20%20complianceState%20%3D%20tostring%28policyStatesProperties.complianceState%29%0A" target="_blank">portal.azure.us</a>
- Azure China 21Vianet portal: <a href="https://portal.azure.cn/?feature.customportal=false#blade/HubsExtension/ArgQueryBlade/query/resources%0A%7C%20where%20type%20%3D~%20%22Microsoft.Storage%2FstorageAccounts%22%0A%7C%20where%20tags%5B%27clusterName%27%5D%20%3D~%20%27tagname%27%0A%7C%20extend%20storageAccountId%20%3D%20tolower%28id%29%0A%7C%20join%20kind%3Dleftouter%28%0A%20%20%20%20policyresources%0A%20%20%20%20%7C%20where%20%5B%27type%27%5D%20%3D~%20%22Microsoft.PolicyInsights%2FpolicyStates%22%0A%20%20%20%20%7C%20project%20storageAccountId%20%3D%20tolower%28properties.resourceId%29%2C%20policyStatesProperties%20%3D%20properties%2C%20resourceType%20%3D%20tostring%28properties.resourceType%29%0A%29%20on%20%24left.storageAccountId%20%3D%3D%20%24right.storageAccountId%0A%7C%20project-away%20storageAccountId%2C%20storageAccountId1%0A%7C%20extend%20policyAssignmentId%20%3D%20tostring%28policyStatesProperties.policyAssignmentId%29%2C%0A%20%20policyAssignmentName%20%3D%20tostring%28policyStatesProperties.policyAssignmentName%29%2C%0A%20%20policyDefinitionId%20%3D%20tostring%28policyStatesProperties.policyDefinitionId%29%2C%0A%20%20policyDefinitionName%20%3D%20tostring%28policyStatesProperties.policyDefinitionName%29%2C%0A%20%20policySetDefinitionName%20%3D%20tostring%28policyStatesProperties.policySetDefinitionName%29%2C%0A%20%20evaluationTime%20%3D%20tostring%28policyStatesProperties.timestamp%29%2C%0A%20%20complianceState%20%3D%20tostring%28policyStatesProperties.complianceState%29%0A" target="_blank">portal.Azure.cn</a>

---
