---
title: Use selective logging feature with script action in Azure HDInsight clusters 
description: Learn how to use Selective logging feature using script action to monitor logs.
ms.service: hdinsight
ms.topic: how-to
ms.custom: seoapr2020, devx-track-azurepowershell, references-regions, devx-track-azurecli
ms.date: 07/31/2022
---

# Learn how to use selective logging feature with script action in Azure HDInsight

[Azure Monitor logs](../azure-monitor/logs/log-query-overview.md) is an Azure Monitor service that monitors your cloud and on-premises environments. The monitoring is to maintain their availability and performance. It collects data generated by resources in your cloud, on-premises environments and from other monitoring tools. The data is used to provide analysis across multiple sources by enabling selective logging feature using script action in Azure portal in HDInsight.

## About selective logging

Selective logging is a part of Azure overall monitoring system. You can connect your cluster to a log analytics workspace. Once enabled, you can see the logs and metrics like HDInsight Security Logs, Yarn Resource Manager, System Metrics etc. You can monitor workloads and see how they're affecting cluster stability. 
Selective logging allows you to enable/disable all the tables or enable selective tables in log analytics workspace. You can adjust the source type for each table, since in new version of Geneva monitoring one table has multiple sources.

> [!NOTE]  
> If log analytics is reinstalled in a cluster, then, you'll have to disable all the tables/log types again, since the reinstallation resets all the configuration files to its original state.

## Using script action

* The Geneva monitoring system uses mdsd(MDS daemon) which is a monitoring agent and fluentd for collecting logs using unified logging layer.
* Selective Logging uses script action to disable/enable tables and their log types. Since it doesn't open any new ports or change any existing security setting hence, there are no security changes.
* Script Action runs in parallel on all specified nodes and changes the configuration files for disabling/enabling tables and their log types.

## Prerequisites

* A Log Analytics workspace. You can think of this workspace as a unique Azure Monitor logs environment with its own data repository, data sources, and solutions. For the instructions, see  [Create a Log Analytics workspace](../azure-monitor/vm/monitor-virtual-machine.md).
* An Azure HDInsight cluster. Currently, you can use selective logging feature with the following HDInsight cluster types:
   * Hadoop
   * HBase
   * Interactive Query
   * Spark

For the instructions on how to create an HDInsight cluster, see [Get started with Azure HDInsight](hadoop/apache-hadoop-linux-tutorial-get-started.md).  

## Enable/disable logs using script action for multiple tables and log types

1. Go to script action in your cluster and create a new Script Action for disabling/enabling table and log type.

    :::image type="content" source="./media/hdinsight-hadoop-oms-selective-log-analytics-tutorial/select-submit-script-action.png" alt-text="Screenshot showing select submit script action.":::

    :::image type="content" source="./media/hdinsight-hadoop-oms-selective-log-analytics-tutorial/submit-script-action-window.png" alt-text="Screenshot showing submit script action window.":::

1. In the script type, select **custom**.
1. Name the script. For example, **Disable two tables and two sources**.
1. Bash Script URL must be the link of the [selectiveLoggingScript.sh](https://hdiconfigactions.blob.core.windows.net/log-analytics-patch/selectiveLoggingScripts/selectiveLoggingScript.sh).
1. Select all the nodes of the cluster. For example, Head Node, Worker node, Zookeepr node.
1. Define the parameters in the parameter box. For example:
   - Spark: `spark HDInsightSparkLogs:SparkExecutorLog --disable`
   - Interactivehive: `interactivehive HDInsightSparkLogs:SparkExecutorLog --enable`
   - Hadoop: `hadoop HDInsightSparkLogs:SparkExecutorLog --disable`
   - HBase: `hbase HDInsightSparkLogs: HDInsightHBaseLogs   --enable`

   For more details, see [Parameters](#parameters-syntax) section.

1. Select Create.
1. After a few minutes, you'll see a green tick next to your script action history, which means script has successfully run.

    :::image type="content" source="./media/hdinsight-hadoop-oms-selective-log-analytics-tutorial/enable-table-and-log-types.png" alt-text="Screenshot showing enable table and log types.":::

You will see the desired changes in the log analytics workspace.

## Troubleshooting

### Scenario 1

If Script Action is submitted but there are no changes in the log analytics workspace.

1. Go to Ambari Home and check debug information.

    :::image type="content" source="./media/hdinsight-hadoop-oms-selective-log-analytics-tutorial/select-dashboard-ambari-home.png" alt-text="Screenshot showing select dashboard ambari home.":::

1. Select settings button.

    :::image type="content" source="./media/hdinsight-hadoop-oms-selective-log-analytics-tutorial/ambari-dash-board.png" alt-text="Screenshot showing ambari dash board.":::

1. You will get your latest script run at the top of the list.

    :::image type="content" source="./media/hdinsight-hadoop-oms-selective-log-analytics-tutorial/background-operations.png" alt-text="Screenshot showing background operations.":::

1. Verify the script run status in all the nodes individually.

    :::image type="content" source="./media/hdinsight-hadoop-oms-selective-log-analytics-tutorial/background-operations-all.png" alt-text="Screenshot showing background operations all.":::

1. Check if the parameter syntax from the parameter syntax section is correct.
1. Check if the log analytics workspace is connected to the cluster and log analytics monitoring is turned on.
1. Check if the script that you run from script action was checked as persisted.

    :::image type="content" source="./media/hdinsight-hadoop-oms-selective-log-analytics-tutorial/script-action-persists.png" alt-text="Screenshot showing script action persists.":::

1. It's possible, that a new node has been added to the cluster recently.

    > [!NOTE]  
    > For the script to run in the latest cluster,  and  the script must persist the script.
   
1. Make sure all the node types are selected while running  the script action.

    :::image type="content" source="./media/hdinsight-hadoop-oms-selective-log-analytics-tutorial/select-node-types.png" alt-text="Screenshot showing select node types.":::

### Scenario 2

If the script action is showing a Failed status in the script action history

1. Make sure the parameter syntax is correct while using the parameter syntax section.
1. Check that the script link is correct.
1. Correct link for the script: https://hdiconfigactions.blob.core.windows.net/log-analytics-patch/selectiveLoggingScripts/selectiveLoggingScript.sh

## Table names

### Spark cluster

Different log types(sources) inside **Spark** tables

| S.no  | Table Name  | Log Types  | Description  |
| --- | --- | --- | --- |
| 1.  | HDInsightAmbariCluster Alerts   | No log types  | This table contains Ambari Cluster Alerts from each node in the cluster (except for edge nodes). Each alert is a record in this table. 
| 2.  | HDInsightAmbariSystem Metrics  | No log types  | This table contains system metrics collected from Ambari. The metrics now come from each node in the cluster (except for edge nodes) instead of just the two headnodes. Each metric is now a column and each metric is reported once per record.  |
| 3.  | HDInsightHadoopAnd YarnLogs   | Head Node: MRJobSummary, Resource Manager, TimelineServer  Worker Node: NodeManager  | This table contains all logs generated from the Hadoop and YARN frameworks.  |
| 4.  | HDInsightSecurityLogs   | AmbariAuditLog, AuthLog  | This table contains records from the Ambari Audit and Auth Logs.  |
| 5.  | HDInsightSparkLogs   | Head Node: JupyterLog, LivyLog, SparkThriftDriverLog  Worker Node: SparkExecutorLog, SparkDriverLog  | This table contains all logs related to Spark and its related component: Livy and Jupyter.  |
| 6.  | HDInsightHadoopAnd YarnMetrics  | No log types   | This table contains JMX metrics from the Hadoop and YARN frameworks. It contains all the same JMX metrics as the old Custom Logs tables, plus more metrics we considered important. We added Timeline Server, Node Manager, and Job History Server metrics. It contains one metric per record.  |
| 7.  | HDInsightOozieLogs  | Oozie  | This table contains all logs generated from the Oozie framework.  |

### Interactive query cluster

Different log types(sources) inside **interactive query** tables

| S.no  | Table Name  | Log Types  | Description  |
| --- | --- | --- | --- |
| 1.  | HDInsightAmbariClusterAlerts   | No log types  | This table contains Ambari Cluster Alerts from each node in the cluster (except for edge nodes). Each alert is a record in this table.  |
| 2.  | HDInsightAmbariSystem Metrics  | No log types  | This table contains system metrics collected from Ambari. The metrics now come from each node in the cluster (except for edge nodes) instead of just the two headnodes. Each metric is now a column and each metric is reported once per record.  |
| 3.  | HDInsightHadoopAndYarnLogs   | **Head Node** : MRJobSummary, Resource Manager, TimelineServer   **WorkerNode:** NodeManager  | This table contains all logs generated from the Hadoop and YARN frameworks.  |
| 4.  | HDInsightHadoopAndYarnMetrics  | No log types   | This table contains JMX metrics from the Hadoop and YARN frameworks. It contains all the same JMX metrics as the old Custom Logs tables, plus more metrics we considered important. We added Timeline Server, Node Manager, and Job History Server metrics. It contains one metric per record.  |
| 5.  | HDInsightHiveAndLLAPLogs   | Head Node: InteractiveHiveHSILog, InteractiveHiveMetastoreLog, ZeppelinLog    | This table contains logs generated from Hive, LLAP, and their related components: WebHCat and Zeppelin.  |
| 6.  | HDInsightHiveAndLLAPmetrics   | No log types  | This table contains JMX metrics from the Hive and LLAP frameworks. It contains all the same JMX metrics as the old Custom Logs tables. It contains one metric per record.  |
| 7.  | HDInsightHiveTezAppStats   | No log types  |
| 8.  | HDInsightSecurityLogs   | **Head Node:** AmbariAuditLog, AuthLog  **Zookeeper Node, Worker Node:** AuthLog  | This table contains records from the Ambari Audit and Auth Logs.  |

### HBase cluster

Different log types(sources) inside **HBase** tables

| S.no  | Table Name  | Log Types  | Description  |
| --- | --- | --- | --- |
| 1.  | HDInsightAmbariClusterAlerts   | No other log types  | This table contains Ambari Cluster Alerts from each node in the cluster (except for edge nodes). Each alert is a record in this table.
| 2.  | HDInsightAmbariSystem Metrics  | No other log types  | This table contains system metrics collected from Ambari. The metrics now come from each node in the cluster (except for edge nodes) instead of just the two headnodes. Each metric is now a column and each metric is reported once per record.  |
| 3.  | HDInsightHadoopAndYarnLogs   | **Head Node** : MRJobSummary, Resource Manager, TimelineServer   **WorkerNode:** NodeManager  | This table contains all logs generated from the Hadoop and YARN frameworks.  |
| 4.  | HDInsightSecurityLogs   | **Head Node:** AmbariAuditLog, AuthLog   **Worker Node:** AuthLog  **ZooKeper Node:** AuthLog  | This table contains records from the Ambari Audit and Auth Logs.  |
| 5.  | HDInsightHBaseLogs   | **Head Node** : HDFSGarbageCollectorLog, HDFSNameNodeLog   **WorkerNode:** PhoenixServerLog, HBaseRegionServerLog, HBaseRestServerLog   **Zookeeper Node:** HBaseMasterLog   | This table contains logs from HBase and its related components: Phoenix and HDFS.  |
| 6.  | HDInsightHBaseMetrics   | No log types  | This table contains JMX metrics from HBase. It contains all the same JMX metrics from the tables listed in the Old Schema column. In contrast from the old tables, each row contains one metric.  |
| 7.  | HDInsightHadoopAndYarn Metrics  | No log types  | This table contains JMX metrics from the Hadoop and YARN frameworks. It contains all the same JMX metrics as the old Custom Logs tables, plus more metrics we considered important. We added Timeline Server, Node Manager, and Job History Server metrics. It contains one metric per record.  |

### Hadoop cluster

Different log types(sources) inside **Hadoop** tables

| S.no  | Table Name  | Log Types  | Description  |
| --- | --- | --- | --- |
| 1.  | HDInsightAmbariClusterAlerts   | No log types  | This table contains Ambari Cluster Alerts from each node in the cluster (except for edge nodes). Each alert is a record in this table.  |
| 2.  | HDInsightAmbariSystem Metrics  | No log types  | This table contains system metrics collected from Ambari. The metrics now come from each node in the cluster (except for edge nodes) instead of just the two headnodes. Each metric is now a column and each metric is reported once per record.  |
| 3.  | HDInsightHadoopAndYarnLogs   | **Head Node:** MRJobSummary, Resource Manager, TimelineServer  Worker Node: NodeManager  | This table contains all logs generated from the Hadoop and YARN frameworks.  |
| 4.  | HDInsightHadoopAndYarnMetrics   |  No Log Types  | This table contains JMX metrics from the Hadoop and YARN frameworks. It contains all the same JMX metrics as the old Custom Logs tables, plus more metrics we considered important. We added Timeline Server, Node Manager, and Job History Server metrics. It contains one metric per record.  |
| 5.  | HDInsightHiveAndLLAPLogs    | **Head Node:** HiveMetastoreLog, HiveServer2Log, WebHcatLog     | This table contains logs generated from Hive, LLAP, and their related components: WebHCat and Zeppelin.  |
| 6.  | HDInsight Hive And LLAP Metrics   | No log types   | This table contains JMX metrics from the Hive and LLAP frameworks. It contains all the same JMX metrics as the old Custom Logs tables. It contains one metric per record.  |
| 7.  | HDInsight Security Logs  | Head Node: AmbariAuditLog, AuthLog  Zookeeper Node: AuthLog   | This table contains records from the Ambari Audit and Auth Logs.  |

## Parameters syntax

Parameters define the cluster type, table names, source names and the action.

:::image type="content" source="./media/hdinsight-hadoop-oms-selective-log-analytics-tutorial/parameter-syntax-box.png" alt-text="Screenshot showing parameter syntax box.":::

Parameter contains three parts:
- Cluster type
- Tables and Log types
- Action (The action can be either `--disable` or `--enable`.)

* Multiple tables syntax
Rule: The tables are separated with a (,) or comma.

For example,

`spark HDInsightSecurityLogs, HDInsightAmbariSystemMetrics --disable`

`hbase HDInsightSecurityLogs, HDInsightAmbariSystemMetrics --enable`

> [!NOTE]  
> The tables are separated with a comma.

* Multiple source type/log type
Rule:The source types/log types are separated with a space.
Rule:For disabling a source the user must write the table name in which the log types is then followed by a colon, then the real log type name.
TableName :  LogTypeName

For example,

spark HDInsightSecurityLogs is a table, which has two log types AmbariAuditLog and AuthLog.
For Disabling both the log types the correct syntax would be:
spark HDInsightSecurityLogs: AmbariAuditLog AuthLog --disable

> [!NOTE]  
>* The source/log types are separated by a space.
>* Table and its source types are separated by a colon.

* Multiple tables and source types
If there are two tables and two source types, which we need to be disabled

- Spark: InteractiveHiveMetastoreLog logtype in HDInsightHiveAndLLAPLogs table
- Hbase: InteractiveHiveHSILog logtype in HDInsightHiveAndLLAPLogs table
- Hadoop: HDInsightHiveAndLLAPMetrics table
- Hadoop: HDInsightHiveTezAppStats table

Correct Parameter syntax for such cases would be

```
interactivehive HDInsightHiveAndLLAPLogs: InteractiveHiveMetastoreLog, HDInsightHiveAndLLAPMetrics, HDInsightHiveTezAppStats, HDInsightHiveAndLLAPLogs: InteractiveHiveHSILog --enable 
```

> [!NOTE] 
>* Different tables are separated with a comma(,).
>* Sources are denoted with a colon(:) after the table name in which they reside.

## Next steps

* [Query Azure Monitor logs to monitor HDInsight clusters](hdinsight-hadoop-oms-log-analytics-use-queries.md)
* [How to monitor cluster availability with Apache Ambari and Azure Monitor logs](./hdinsight-cluster-availability.md)
