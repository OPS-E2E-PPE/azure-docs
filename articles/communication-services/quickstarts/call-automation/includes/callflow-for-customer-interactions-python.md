---
title: include file
description: Provides a quickstart on how to use Call Automation Python SDK to build call flow for customer interactions.
services: azure-communication-services
author: richardcho

ms.service: azure-communication-services
ms.subservice: call-automation
ms.date: 06/09/2023
ms.topic: include
ms.custom: include file
ms.author: richardcho
---

## Prerequisites

- An Azure account with an active subscription.
- Azure Communication Services resource. See [Create an Azure Communication Services resource](../../create-communication-resource.md?tabs=windows&pivots=platform-azp). Note the resource connection string for this quickstart by navigating to your resource selecting 'Keys' from the left side menu.
- [Acquire a phone number for your Communication Service resource](../../telephony/get-phone-number.md?pivots=programming-language-csharp) or connect your carrier using [Azure direct routing](../../../concepts/telephony/direct-routing-infrastructure.md). Note the phone number you acquired or provisioned using Azure direct routing for use in this quickstart.
- [Python 3](https://www.python.org/downloads/) installed on your operating system. It's also recommended to set up a [virtual environment](https://docs.python.org/3/library/venv.html). we'll run the application in the virtual environment for the sample below.
- An audio file for the message you want to play in the call. This audio should be accessible via a url.

## Create a new python application

Create a new web application and set up the virtual environment.

```console
mkdir <python_project_directory> && \
python -m venv <python_project_directory>
```

Create a new python file `app.py`.

## Install required packages

Install the following dependencies to your project. We use [flask](https://pypi.org/project/Flask/) to create the web application.

```console
python -m pip install flask azure-communication-callautomation
```

## Set up a public URI for the local application

In this quick-start, we'll use [Ngrok tool](https://ngrok.com/) to project a public URI to the local port so that your local application can be visited by the internet. The public URI is needed to receive the Event Grid `IncomingCall` event and Call Automation events using webhooks.

First, decide the port for your application. `5000` is the default endpoint of a flask app.

Then, [install Ngrok](https://ngrok.com/download) and run Ngrok with the following command: `ngrok http <port>`. This command creates a public URI like `https://ff2f-75-155-253-232.ngrok.io/`, and it is your Ngrok Fully Qualified Domain Name(Ngrok_FQDN). Keep Ngrok running while following the rest of this quick-start.

## Handle incoming calls

In this code snippet, /api/incomingCall is the default route that is used to listen for and answer incoming calls. At a later step, you'll register this url with Event Grid. Since Event Grid requires you to prove ownership of your Webhook endpoint before it starts delivering events to that endpoint, the code sample also handles this one time validation by processing SubscriptionValidationEvent. This requirement prevents a malicious user from flooding your endpoint with events. For more information, see this [guide](../../../../event-grid/webhook-event-delivery.md).  

The code sample also illustrates how you can control the callback URI by setting your own context/ID when you answer the call. All events generated by the call will be sent to the specific route you provide when answering an inbound call and the same applies to when you place an outbound call.  

Add the following snippet to `app.py`

```python
from flask import Flask, request, make_response, jsonify
from azure.communication.callautomation import (
    CallAutomationClient,
    identifier_from_raw_id,
    FileSource,
    DtmfTone,
    CallInvite,
    PhoneNumberIdentifier,
)

app = Flask(__name__)

public_uri = "<ngrokPublicUrl>"
connection_string = "<connectionStringOfCommunicationResource>"
media_url = "<linkToMediaFile>"
phoneNumber_to_call = "<phoneNumberToCall>"  # in E.164 format
application_phone_number = "<phoneNumberAcquiredAsPrerequisite>"
call_automation_client = CallAutomationClient.from_connection_string(connection_string)


@app.route("/api/incomingCall", methods=["POST"])
def handle_incoming_call():
    try:
        for event_grid_event in request.get_json():
            event_data = event_grid_event["data"]

            if (
                event_grid_event["eventType"]
                == "Microsoft.EventGrid.SubscriptionValidationEvent"
            ):
                validation_response = {
                    "validationResponse": event_data["validationCode"],
                    "status": 200,
                }
                response = make_response(jsonify(validation_response))

                return response

            if event_grid_event["eventType"] == "Microsoft.Communication.IncomingCall":
                call_automation_client.answer_call(
                    incoming_call_context=event_data["incomingCallContext"],
                    callback_url="%s/api/calls?callerId=%s"
                    % (public_uri, event_data["from"]["rawId"]),
                )

        return "", 200
    except Exception as e:
        return e, 500


@app.route("/api/calls", methods=["POST"])
def handle_callback_events():
    print(request.get_json())
    try:
        for callback_event in request.get_json():
            call_connection_id = callback_event["data"]["callConnectionId"]
            call_connection_client = call_automation_client.get_call_connection(
                call_connection_id
            )

            if callback_event["type"] == "Microsoft.Communication.CallConnected":
                raw_id = request.args.get("callerId")

                call_connection_client.start_recognizing_media(
                    target_participant=identifier_from_raw_id(raw_id),
                    initial_silence_timeout=5,
                    play_prompt=FileSource(media_url),
                    operation_context="MainMenu",
                    interrupt_prompt=True,
                    dtmf_inter_tone_timeout=10,
                    dtmf_max_tones_to_collect=3,
                    dtmf_stop_tones=[DtmfTone.POUND],
                )

            if callback_event["type"] == "Microsoft.Communication.RecognizeCompleted":
                call_invite = CallInvite(
                    target=PhoneNumberIdentifier(phoneNumber_to_call),
                    source_caller_id_number=PhoneNumberIdentifier(
                        application_phone_number
                    ),
                )
                call_connection_client.add_participant(call_invite)

        return "", 200
    except Exception as e:
        return e, 500


if __name__ == "__main__":
    app.run()
```

Replace the placeholders with the actual values.

## Run the app

```console
python app.py
```

## Configure Event Grid webhook subscription

In order to receive the `IncomingCall` event for the inbound PSTN call, you must configure an Event Grid subscription as described in this [concepts guide](../../../concepts/call-automation/incoming-call-notification.md). The most important thing to remember is that an Event Grid webhook subscription must be validated against a working web server. Since you've started the project in the previous step, and you have a public FQDN, set the webhook address in your subscription to your POST endpoint (`https://<ngrokPublicUrl>/api/incomingCall`).

Once your webhook subscription has been validated, it will show up in the portal, and you're now ready to test your application by making an inbound call.
