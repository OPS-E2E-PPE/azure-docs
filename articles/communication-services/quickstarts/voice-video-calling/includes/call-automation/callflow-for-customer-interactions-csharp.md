---
title: include file
description: Provides a quickstart on how to use Call Automation C# SDK to build call flow for customer interactions.
services: azure-communication-services
author: ashwinder

ms.service: azure-communication-services
ms.subservice: azure-communication-services
ms.date: 09/06/2022
ms.topic: include
ms.custom: include file
ms.author: askaur
---

## Prerequisites

- An Azure account with an active subscription.
- A deployed Communication Service resource.
- [Acquire a PSTN phone number from the Communication Service resource](../../../telephony/get-phone-number.md?pivots=programming-language-csharp).
- The latest [.NET library](https://dotnet.microsoft.com/download/dotnet-core) for your operating system.
- A [web service application](https://dotnet.microsoft.com/download/dotnet-core) to handle web hook callback events.
- Optional: [NGROK application](https://ngrok.com/) to proxy HTTP/S requests to a local development machine.
- The [ARMClient application](https://github.com/projectkudu/ARMClient), used to configure the Event Grid subscription.
- Obtain the NuGet package from the [Azure SDK Dev Feed](https://github.com/Azure/azure-sdk-for-net/blob/main/CONTRIBUTING.md#nuget-package-dev-feed)

## Configure an Event Grid subscription

The Call Automation platform uses Event Grid to deliver the IncomingCall event to a subscription of your choice. For this guide, we'll use a web hook subscription pointing to your NGROK application proxy address.

1. Locate and copy the following to be used in the armclient command-line statement below:
    - Azure subscription ID
    - Resource group name

    On the picture below you can see the required fields:

    :::image type="content" source="./../../media/call-automation/portal.png" alt-text="Screenshot of Communication Services resource page on Azure portal.":::

2. Communication Service resource name
3. Determine your local development HTTP port used by your web service application.
4. Start NGROK by issuing the following command from a command prompt.

    ```console
    ngrok http <https://localhost:<your_web_service_port>>
    ```

    This command will produce a public URI you can use to receive the events from the Event Grid subscription.

5. Optional: Determine an API route path for the incoming call event together with your NGROK URI that will be used in the armclient command-line statement below, for example: `https://ff2f-75-155-253-232.ngrok.io/api/incomingcall`.
6. Event Grid web hooks require a valid reachable endpoint before they can be created. As such, start your web service application and run the commands below.
7. Since the `IncomingCall` event isn't yet published in the portal, you must run the following command-line statements to configure your subscription:

    ``` console
    armclient login

    armclient put "/subscriptions/<your_azure_subscription_guid>/resourceGroups/<your_resource_group_name>/providers/Microsoft.Communication/CommunicationServices/<your_acs_resource_name>/providers/Microsoft.EventGrid/eventSubscriptions/<subscription_name>?api-version=2022-06-15" "{'properties':{'destination':{'properties':{'endpointUrl':'<your_ngrok_uri>'},'endpointType':'WebHook'},'filter':{'includedEventTypes': ['Microsoft.Communication.IncomingCall']}}}" -verbose
    ```

## Create a new C# application

In the console window of your operating system, use the `dotnet` command to create a new web application.

```console
dotnet new web -n MyApplication
```

## Install the NuGet package

During the preview phase, the NuGet package can be obtained by configuring your package manager to use the Azure SDK Dev Feed from [here](https://github.com/Azure/azure-sdk-for-net/blob/main/CONTRIBUTING.md#nuget-package-dev-feed)

## Obtain your connection string

From the Azure portal, locate your Communication Service resource and click on the Keys section to obtain your connection string.

:::image type="content" source="./../../media/call-automation/Key.png" alt-text="Screenshot of Communication Services resource page on portal to access keys":::

## Configure Program.cs to answer the call

Using the minimal API feature in .NET 6, we can easily add an HTTP POST map and answer the call. A callback URI is required so the service knows how to contact your web server for subsequent calls state events such as `CallConnected` and `PlayCompleted`.  

NOTE: The code sample also illustrates how you can control the callback URI by setting your own context/ID when you answer the call. All events generated by the call will be sent to the specific route you provide when answering an inbound call and the same applies to when you place an outbound call.
```csharp
using Azure.Communication;
using Azure.Communication.CallingServer;
using Azure.Messaging.EventGrid;
using Microsoft.AspNetCore.Mvc;
using System.Text.Json;

var builder = WebApplication.CreateBuilder(args);

var client = new CallAutomationClient(builder.Configuration["ACS:ConnectionString"]);
var callbackUriBase = "<YOUR_NGROK_FQDN>"; // i.e. https://someguid.ngrok.io

var app = builder.Build();

app.MapPost("/api/incomingCall", async (
    [FromBody] EventGridEvent[] eventGridEvents) =>
    {
        foreach (var eventGridEvent in eventGridEvents)
        {
            // Handle system events
            if (eventGridEvent.TryGetSystemEventData(out object eventData))
            {
                // Handle the subscription validation event
                if (eventData is SubscriptionValidationEventData subscriptionValidationEventData)
                {
                    var responseData = new SubscriptionValidationResponse
                    {
                        ValidationResponse = subscriptionValidationEventData.ValidationCode
                    };
                    return Results.Ok(responseData);
                }
            }

            var jsonObject = JsonNode.Parse(eventGridEvent.Data).AsObject();
            var incomingCallContext = (string)jsonObject["incomingCallContext"];
            var callbackUri = new Uri(callbackUriBase + $"/api/calls/{Guid.NewGuid()}");
            AnswerCallResult answerCallResult = await client.AnswerCallAsync(incomingCallContext, callbackUri);
        }

        return Results.Ok();
    });

app.MapPost("/api/calls/{contextId}", async (
    [FromBody] CloudEvent[] cloudEvents,
    [FromRoute] string contextId) =>
{
    foreach (var cloudEvent in cloudEvents)
    {
        CallAutomationEventBase @event = CallAutomationEventParser.Parse(cloudEvent);
        if (@event == typeof(CallConnected))
        {
            // play audio file to caller
            var playSource = new FileSource("<INSERT_AUDIO_FILE_URI>");
            var playOptions = new PlayOptions() { Loop = true };
            await client.GetCallConnection(@event.CallConnectionId)
                .GetCallMedia()
                .PlayToAllAsync(playSource, playOptions);
        }
        if (@event == typeof(PlayCompleted))
        {            
            // add ACS user as a participant to the call after audio has completed playing
            await client.GetCallConnection(@event.CallConnectionId)
                .AddParticipantsAsync(new List<CommunicationIdentifier>() { new CommunicationUserIdentifier("<ACS_USER_ID>")});
        }
    }

    return Results.Ok();
}).Produces(StatusCodes.Status200OK);

app.Run();
```

## Testing the application

1. Place a call to the number you acquired in the Azure portal (see prerequisites above).
2. Your Event Grid subscription to the `IncomingCall` should execute and call your web server.
3. The call will be answered, and an asynchronous web hook callback will be sent to the NGROK callback URI.
4. When the call is connected, a `CallConnected` event will be sent to your web server, wrapped in a `CloudEvent` schema and can be easily deserialized using the Call Automation SDK parser. At this point, the application will request audio to be played in a loop to all participants on the call.
5. When the audio file has played, a `PlayCompleted` event is received, and the web server will make a request to add a participant to the call.
