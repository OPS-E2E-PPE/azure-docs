---
title: How to use Azure Managed Service Identity in Azure API Management | Microsoft Docs
description: Learn how to use Azure Managed Service Identity in API Management
services: api-management
documentationcenter: ''
author: miaojiang
manager: anneta
editor: ''

ms.service: api-management
ms.workload: integration
ms.topic: article
ms.date: 10/18/2017
ms.author: apimpm
---

# How to use Azure Managed Service Identity in Azure API Management

> [!Note]
> Managed Service Identity for Azure API Management is currently in preview.

This topic shows you how to create a managed service identity for an API Management service instance and how to access other resources. A managed service identity generated by Azure Active Directory (AAD) allows your API Management instance to easily and securely access other AAD-protected resources such as Azure Key Vault. This managed service identity is managed by Azure and does not require you to provision or rotate any secrets. For more about Azure Managed Service Identity, see [Managed Service Identity Overview](../active-directory/msi-overview.md).

## Creating an API Management instance with an identity using an Azure Resource Manager template

An API Management instance can be created with an identity by including the following property in the resource definition. 

```json
"identity" : {
    "type" : "SystemAssigned"
}
```

This tells Azure to create and manage the identity for your API Management instance. 

For example, a complete template might look like the following:

```json
{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "0.9.0.0",
    "parameters": {
        "serviceName": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "The name of the api management service"
            }
        },
        "publisherEmail": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "admin@contoso.com",
            "metadata": {
                "description": "The email address of the owner of the service"
            }
        },
        "publisherName": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "Contoso",
            "metadata": {
                "description": "The name of the owner of the service"
            }
        },
        "sku": {
            "type": "string",
            "allowedValues": [
                "Developer",
                "Standard",
                "Premium"
            ],
            "defaultValue": "Developer",
            "metadata": {
                "description": "The pricing tier of this API Management service"
            }
        },
        "skuCount": {
            "type": "int",
            "defaultValue": 1,
            "metadata": {
                "description": "The instance size of this API Management service."
            }
        }
    },
    "resources": [
        {
            "apiVersion": "2017-03-01",
            "name": "[parameters('serviceName')]",
            "type": "Microsoft.ApiManagement/service",
            "location": "[resourceGroup().location]",
            "tags": {},
            "sku": {
                "name": "[parameters('sku')]",
                "capacity": "[parameters('skuCount')]"
            },
            "properties": {
                "publisherEmail": "[parameters('publisherEmail')]",
                "publisherName": "[parameters('publisherName')]"
            },
            "identity": { 
                "type": "systemAssigned" 
            }
        }
    ]
}
```

## Obtaining a certificate from Azure Key Vault

The below example shows how to obtain a certificate from Azure Key Vault. It contains the following steps:

* Create an API Management instance with an identity
* Update the access policies of an Azure Key Vault instance and allow the API Management instance to obtain secrets from it
* Update the API Management instance by setting a custom domain name using a certificate from the Key Vault instance

> [!Important]
> If the object version of the certificate is not provided, API Management will automatically obtain the newer version of the certificate after it is uploaded to Key Vault. 

```json
{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"publisherEmail": {
			"type": "string",
			"minLength": 1,
			"metadata": {
				"description": "The email address of the owner of the service"
			}
		},
		"publisherName": {
			"type": "string",
            "defaultValue": "Contoso",
			"minLength": 1,
			"metadata": {
				"description": "The name of the owner of the service"
			}
		},
		"sku": {
			"type": "string",
			"allowedValues": ["Developer",
			"Standard",
			"Premium"],
			"defaultValue": "Developer",
			"metadata": {
				"description": "The pricing tier of this API Management service"
			}
		},
		"skuCount": {
			"type": "int",
			"defaultValue": 1,
			"metadata": {
				"description": "The instance size of this API Management service."
			}
		},
		"keyVaultName": {
			"type": "string",
			"metadata": {
				"description": "Name of the vault"
			}
		},
		"proxyCustomHostname1": {
            "type": "string",
            "metadata": {
                "description": "Proxy Custom hostname."
            }
        },
        "keyVaultIdToCertificate": {
            "type": "string",
            "metadata": {
                "description": "Reference to the KeyVault certificate."
            }
        }
	},
	"variables": {
		"apiManagementServiceName": "[concat('apiservice', uniqueString(resourceGroup().id))]",
		"apimServiceIdentityResourceId": "[concat(resourceId('Microsoft.ApiManagement/service', variables('apiManagementServiceName')),'/providers/Microsoft.ManagedIdentity/Identities/default')]"
	},
	"resources": [{
		"apiVersion": "2017-03-01",
		"name": "[variables('apiManagementServiceName')]",
		"type": "Microsoft.ApiManagement/service",
		"location": "[resourceGroup().location]",
		"tags": {
			
		},
		"sku": {
			"name": "[parameters('sku')]",
			"capacity": "[parameters('skuCount')]"
		},
		"properties": {
			"publisherEmail": "[parameters('publisherEmail')]",
			"publisherName": "[parameters('publisherName')]"
		},
		"identity": {
			"type": "systemAssigned"
		}
	},
	{
		"type": "Microsoft.KeyVault/vaults/accessPolicies",
		"name": "[concat(parameters('keyVaultName'), '/add')]",
		"apiVersion": "2015-06-01",        
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service', variables('apiManagementServiceName'))]"
      ],
		"properties": {
			"accessPolicies": [{
				"tenantId": "[reference(variables('apimServiceIdentityResourceId'), '2015-08-31-PREVIEW').tenantId]",
				"objectId": "[reference(variables('apimServiceIdentityResourceId'), '2015-08-31-PREVIEW').principalId]",
				"permissions": {
					"secrets": ["get"]
				}
			}]
		}
	},
	{ 
      "apiVersion": "2017-05-10", 
      "name": "apimWithKeyVault", 
      "type": "Microsoft.Resources/deployments",
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service', variables('apiManagementServiceName'))]"
      ],
      "properties": { 
        "mode": "incremental", 
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/solankisamir/arm-templates/master/basicapim.keyvault.json",
          "contentVersion": "1.0.0.0"
        }, 
        "parameters": {
			"publisherEmail": { "value": "[parameters('publisherEmail')]"},
			"publisherName": { "value": "[parameters('publisherName')]"},
			"sku": { "value": "[parameters('sku')]"},
		    "skuCount": { "value": "[parameters('skuCount')]"},
		    "proxyCustomHostname1": {"value" : "[parameters('proxyCustomHostname1')]"},
            "keyVaultIdToCertificate": {"value" : "[parameters('keyVaultIdToCertificate')]"}
		}
      } 
	}]
}
```

## Next steps

* Learn more about Azure Managed Service Identity
  * [Managed Service Identity Overview](../active-directory/msi-overview.md)
  * [See more Azure Resource Manager     templates](https://github.com/Azure/azure-quickstart-templates)

