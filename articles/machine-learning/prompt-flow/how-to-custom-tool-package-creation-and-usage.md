---
title: Custom tool package creation and usage in Prompt Flow (preview)
titleSuffix: Azure Machine Learning
description: Learn how to develop your own tool package in Prompt Flow. 
services: machine-learning
ms.service: machine-learning
ms.subservice: prompt-flow
ms.topic: how-to
author: ChenJieting
ms.author: chenjieting
ms.reviewer: lagayhar
ms.date: 09/12/2023
---

# Custom tool package creation and usage (preview)

In this article, we'll guide you through the process of developing your own tool package, offering detailed steps and advice on how to utilize your creation.

> [!IMPORTANT]
> Prompt flow is currently in public preview. This preview is provided without a service-level agreement, and are not recommended for production workloads. Certain features might not be supported or might have constrained capabilities.
> For more information, see [Supplemental Terms of Use for Microsoft Azure Previews](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## Create your own tool package

Your tool package should be a Python package. To try, see [my-tools-package 0.0.1](https://pypi.org/project/my-tools-package/) and skip this section.

### Prerequisites

Create a new conda environment using Python 3.9 or 3.10. Run the following command to install Prompt Flow dependencies:

```sh
# eventually only need to install promptflow
pip install promptflow-sdk promptflow --extra-index-url https://azuremlsdktestpypi.azureedge.net/promptflow/
```

Install Pytest packages for running tests:

```sh
pip install pytest
pip install pytest-mock
```

### Create custom tool package

Run the following command under root folder to create your tool project quickly:

```sh
python scripts\generate_tool_package_template.py --destination <your-tool-project> --package-name <your-package-name> --tool-name <your-tool-name> --function-name <your-tool-function-name>
```

For example:

```sh
python scripts\generate_tool_package_template.py --destination hello-world-proj --package-name hello-world --tool-name hello_world_tool --function-name get_greeting_message
```

This autogenerated script will create one tool for you. The parameters _destination_ and _package-name_ are mandatory. The parameters _tool-name_ and _function-name_ are optional. If left unfilled, the _tool-name_ will default to _hello_world_tool_, and the _function-name_ will default to _tool-name_.

The command will generate the tool project as follows with one tool `hello_world_tool.py` in it:

:::image type="content" source="./media/how-to-custom-tool-package-creation-and-usage/tool-folder-structure.png" alt-text="Screenshot of folder and file structure in VS Code."lightbox = "./media/how-to-custom-tool-package-creation-and-usage/tool-folder-structure.png":::

The following points outlined explain the purpose of each folder/file in the package. If your aim is to develop multiple tools within your package, make sure to closely examine bullet hello-world/tools and hello_world/yamls/hello_world_tool.yaml:

- **hello-world-proj**: This is the source directory. All of your project's source code should be placed in this directory.

- **hello-world/tools**: This directory contains the individual tools for your project. Your tool package can contain either one tool or many tools. When adding a new tool, you should create another *_tool.py under the `tools` folder.

- **hello-world/tools/hello_world_tool.py**: Develop your tool within the def function. Use the `@tool` decorator to identify the function as a tool.
    > [!Note]
    > There are two ways to write a tool. The default and recommended way is the function implemented way. You can also use the class implementation way, referring to [my_tool_2.py](https://github.com/Azure/promptflow/blob/main/tool-package-quickstart/my_tool_package/tools/my_tool_2.py) as an example.

- **hello-world/tools/utils.py**: This file implements the tool list method, which collects all the tools defined. It's required to have this tool list method, as it allows the User Interface (UI) to retrieve your tools and display them within the UI.

    > [!Note]
    > There's no need to create your own list method if you maintain the existing folder structure. You can simply use the auto-generated list method provided in the `utils.py` file.

- **hello_world/yamls/hello_world_tool.yaml**: Tool YAMLs defines the metadata of the tool. The tool list method, as outlined in the `utils.py`, fetches these tool YAMLs.

    You may want to update `name` and `description` to a better one in `your_tool.yaml`, so that tool can have a great name and description hint in prompt flow UI.

    > [!Note]
    > If you create a new tool, don't forget to also create the corresponding tool YAML. you can use the following command under your tool project to auto generate your tool YAML.

    ```sh
    python ..\scripts\package_tools_generator.py -m <tool_module> -o <tool_yaml_path>
    ```

    For example:

    ```sh
    python ..\scripts\package_tools_generator.py -m hello_world.tools.hello_world_tool -o hello_world\yamls\hello_world_tool.yaml
     ```

    To populate your tool module, adhere to the pattern `\<package_name\>.tools.\<tool_name\>`, which represents the folder path to your tool within the package.

- **tests**: This directory contains all your tests, though they aren't required for creating your custom tool package. When adding a new tool, you can also create corresponding tests and place them in this directory. Run the following command under your tool project:

    ```sh
    pytest tests
    ```

- **MANIFEST.in**: This file is used to determine which files to include in the distribution of the project. Tool YAML files should be included in MANIFEST.in so that your tool YAMLs would be packaged and your tools can show in the UI.

    > [!Note]
    > There's no need to update this file if you maintain the existing folder structure.

- **setup.py**: This file contains metadata about your project like the name, version, author, and more. Additionally, the entry point is automatically configured for you in the `generate_tool_package_template.py` script. In Python, configuring the entry point in `setup.py` helps establish the primary execution point for a package, streamlining its integration with other software.

    The `package_tools` entry point together with the tool list method are used to retrieve all the tools and display them in the UI.

    ```python
    entry_points={
          "package_tools": ["<your_tool_name> = <list_module>:<list_method>"],
    },
    ```

    > [!Note]
    > There's no need to update this file if you maintain the existing folder structure.

### Build and share the tool package

  Execute the following command in the tool package root directory to build your tool package:

  ```sh
  python setup.py sdist bdist_wheel
  ```

  This will generate a tool package `<your-package>-0.0.1.tar.gz` and corresponding `whl file` inside the `dist` folder.

  [Create an account on PyPI](https://pypi.org/account/register/) if you don't already have one, and install `twine` package by running `pip install twine`.

  Upload your package to PyPI by running `twine upload dist/*`, this will prompt you for your Pypi username and password, and then upload your package on PyPI. Once your package is uploaded to PyPI, others can install it using pip by running `pip install your-package-name`. Make sure to replace `your-package-name` with the name of your package as it appears on PyPI.

  If you only want to put it on Test PyPI, upload your package by running `twine upload --repository-url https://test.pypi.org/legacy/ dist/*`. Once your package is uploaded to Test PyPI, others can install it using pip by running `pip install --index-url https://test.pypi.org/simple/ your-package-name`.

## Prepare runtime

You can create runtime with CI (Compute Instance) or MIR (Managed Inference Runtime). CI is the recommended way.

### Create customized environment

1. Create a customized environment with docker context.

   1. Create a customized environment in Azure Machine Learning studio by going to **Environments**  then select **Create**. In the settings tab under *Select environment source*, choose " Create a new docker content".

       Currently we support creating environment with "Create a new docker context" environment source. "Use existing docker image with optional conda file" has known [limitation](../how-to-manage-environments-v2.md#create-an-environment-from-a-conda-specification) and isn't supported now.

        :::image type="content" source="./media/how-to-custom-tool-package-creation-and-usage/create-customized-environment-step-1.png" alt-text="Screenshot of create environment in Azure Machine Learning studio."lightbox = "./media/how-to-custom-tool-package-creation-and-usage/create-customized-environment-step-1.png":::

   1. Under **Customize**, replace the text in the Dockerfile:

       ```sh
       FROM mcr.microsoft.com/azureml/promptflow/promptflow-runtime:latest
       RUN pip install -i https://test.pypi.org/simple/ my-tools-package==0.0.1
       ```

         :::image type="content" source="./media/how-to-custom-tool-package-creation-and-usage/create-customized-environment-step-2.png" alt-text="Screenshot of create environment in Azure Machine Learning studio on the customize step."lightbox ="./media/how-to-custom-tool-package-creation-and-usage/create-customized-environment-step-2.png":::
    
       It will take several minutes to create the environment. After it succeeded, you can copy the Azure Container Registry (ACR) from environment detail page for the next step.

2. Create another environment with inference config. This is to support create MIR runtime with the customized environment and deployment scenario.

   >[!Note]
   > This step can only be done through CLI, AML studio UI doesn't support creating environment with inference_config today.

   Create env.yaml file like below example:
   >[!Note]
   > Remember to replace the ACR in the 'image' field.

   ```yaml
   $schema: https://azuremlschemas.azureedge.net/latest/environment.schema.json
   name: my-tool-env-with-inference

   # Once the image build succeed in last step, you will see ACR from environment detail page, replace the ACR path here.
   image: a0e352e5655546debe782dc5cb4a52df.azurecr.io/azureml/azureml_39b1850f1ec09f5500365d2b3be13b96

   description: promptflow enrivonment with custom tool packages

   # make sure the inference_config is specified in yaml, otherwise the endpoint deployment won't work
   inference_config:
      liveness_route:
         port: 8080
         path: /health
      readiness_route:
         port: 8080
         path: /health
      scoring_route:
         port: 8080
         path: /score
   ```

   Run Azure Machine Learning CLI to create environment:

   ```cli
   # optional
   az login

   # create your environment in workspace
   az ml environment create --subscription <sub-id> -g <resource-group> -w <workspace> -f env.yaml
   ```

### Prepare runtime with CI or MIR

3. Create runtime with CI using the customized environment created in step 2.
    1. Create a new compute instance. Existing compute instance created long time ago may hit unexpected issue.
    1. Create runtime on CI with customized environment.

    :::image type="content" source="./media/how-to-custom-tool-package-creation-and-usage/create-runtime-on-compute-instance.png" alt-text="Screenshot of add compute instance runtime in Azure Machine Learning studio."lightbox ="./media/how-to-custom-tool-package-creation-and-usage/create-runtime-on-compute-instance.png":::

4. Create runtime with MIR using the customized environment created in step 2. To learn how to create a runtime with MIR, see [How to create a manage runtime](how-to-create-manage-runtime.md).

    :::image type="content" source="./media/how-to-custom-tool-package-creation-and-usage/create-runtime-on-managed-inference-runtime.png" alt-text="Screenshot of add managed online deployment runtime in Azure Machine Learning studio."lightbox = "./media/how-to-custom-tool-package-creation-and-usage/create-runtime-on-managed-inference-runtime.png":::

## Test from Prompt Flow UI

>[!Note]
> Currently you need to append flight `PFPackageTools` after studio url.

1. Create a standard flow.
2. Select the correct runtime ("my-tool-runtime") and add your tools.
    :::image type="content" source="./media/how-to-custom-tool-package-creation-and-usage/test-customer-tool-on-ui-step-1.png" alt-text="Screenshot of flow in Azure Machine Learning studio showing the runtime and more tools dropdown."lightbox ="./media/how-to-custom-tool-package-creation-and-usage/test-customer-tool-on-ui-step-1.png":::
3. Change flow based on your requirements and run flow in the selected runtime.
    :::image type="content" source="./media/how-to-custom-tool-package-creation-and-usage/test-customer-tool-on-ui-step-2.png" alt-text="Screenshot of flow in Azure Machine Learning studio showing adding a tool."lightbox ="./media/how-to-custom-tool-package-creation-and-usage/test-customer-tool-on-ui-step-2.png":::

## Test from VS Code extension

1. Download the latest version [Prompt flow extension](https://ms.portal.azure.com/#view/Microsoft_Azure_Storage/ContainerMenuBlade/~/overview/storageAccountId/%2Fsubscriptions%2F96aede12-2f73-41cb-b983-6d11a904839b%2Fresourcegroups%2Fpromptflow%2Fproviders%2FMicrosoft.Storage%2FstorageAccounts%2Fpfvscextension/path/pf-vscode-extension/etag/%220x8DB7169BD91D29C%22/defaultEncryptionScope/%24account-encryption-key/denyEncryptionScopeOverride~/false/defaultId//publicAccessVal/None).

2. Install the extension in VS Code via "Install from VSIX":
    :::image type="content" source="./media/how-to-custom-tool-package-creation-and-usage/install-vsix.png" alt-text="Screenshot of the VS Code extensions showing install from VSIX under the ellipsis." lightbox = "./media/how-to-custom-tool-package-creation-and-usage/install-vsix.png":::
    
3. Go to terminal and install your tool package in conda environment of the extension. By default, the conda env name is `prompt-flow`.

   ```sh
   (local_test) PS D:\projects\promptflow\tool-package-quickstart> conda activate prompt-flow
   (prompt-flow) PS D:\projects\promptflow\tool-package-quickstart> pip install .\dist\my_tools_package-0.0.1-py3-none-any.whl
   ```

4. Go to the extension and open one flow folder. Select 'flow.dag.yaml' and preview the flow. Next, select `+` button and you'll see your tools. You may need to reload the windows to clean previous cache if you don't see your tool in the list.

    :::image type="content" source="./media/how-to-custom-tool-package-creation-and-usage/auto-list-tool-in-extension.png" alt-text="Screenshot of the VS Code showing the tools." lightbox ="./media/how-to-custom-tool-package-creation-and-usage/auto-list-tool-in-extension.png":::

## FAQ

### Why is my custom tool not showing up in the UI?

- Ensure that you've set the UI flight to `&flight=PFPackageTools`.
- Confirm that the tool YAML files are included in your custom tool package. You can add the YAML files to [MANIFEST.in](https://github.com/Azure/promptflow/blob/main/tool-package-quickstart/MANIFEST.in) and include the package data in [setup.py](https://github.com/Azure/promptflow/blob/main/tool-package-quickstart/setup.py).
Alternatively, you can test your tool package using the following script to ensure that you've packaged your tool YAML files and configured the package tool entry point correctly.

  1. Make sure to install the tool package in your conda environment before executing this script.
  2. Create a python file anywhere and copy the following content into it.

      ```python
      def test():
          # `collect_package_tools` gathers all tools info using the `package-tools` entry point. This ensures that your package is correctly packed and your tools are accurately collected. 
          from promptflow.core.tools_manager import collect_package_tools
          tools = collect_package_tools()
          print(tools)
      if __name__ == "__main__":
          test()
      ```

  3. Run this script in your conda environment. This will return the metadata of all tools installed in your local environment, and you should verify that your tools are listed.
- If you're using runtime with CI, try to restart your container with command `docker restart <container_name_or_id>` to see if the issue can be resolved.

### Why am I unable to upload package to PyPI?

- Make sure that the entered username and password of your PyPI account are accurate.
- If you encounter a `403 Forbidden Error`, it's likely due to a naming conflict with an existing package. You'll need to choose a different name. Package names must be unique on PyPI to avoid confusion and conflicts among users. Before creating a new package, it's recommended to search PyPI (https://pypi.org/) to verify that your chosen name isn't already taken. If the name you want is unavailable, consider selecting an alternative name or a variation that clearly differentiates your package from the existing one.

## Next steps

- Learn more about [customize environment for runtime](how-to-customize-environment-runtime.md)